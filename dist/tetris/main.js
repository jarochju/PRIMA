"use strict";
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
var Tetris;
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
(function (Tetris) {
    var ƒ = FudgeCore;
    let GameState;
    (function (GameState) {
        GameState[GameState["RUNNING"] = 0] = "RUNNING";
        GameState[GameState["PAUSED"] = 1] = "PAUSED";
        GameState[GameState["STOPPED"] = 2] = "STOPPED";
    })(GameState || (GameState = {}));
    window.addEventListener('load', hndLoad);
    let graph;
    let activeShape;
    let colliders = [];
    let lastUpdate = 0;
    let audioCmp;
    let bgMusic;
    let isMuted = false;
    let counterUI;
    let level;
    let gameState = GameState.STOPPED;
    let gameData;
    let gameDifficulty = 'medium';
    async function hndLoad(_event) {
        const canvas = document.querySelector('canvas');
        /** Control DOM Elements */
        const startBtn = document.querySelector('#start-btn');
        const newGameBtn = document.querySelector('#new-game-btn');
        const muteBtn = document.querySelector('#mute-btn');
        const difficultySelect = document.querySelector('#difficulty-select');
        counterUI = new Tetris.UIElement('#counter');
        if (newGameBtn)
            newGameBtn.addEventListener('click', handleStartClick);
        if (startBtn)
            startBtn.addEventListener('click', handlePauseClick);
        if (muteBtn)
            muteBtn.addEventListener('click', handleMuteClick);
        if (difficultySelect) {
            difficultySelect.value = 'medium';
            difficultySelect.addEventListener('change', handleDifficultyChange);
        }
        const storage = new Tetris.Storage('./data.json');
        await storage.loadData();
        gameData = storage.getData();
        // setze Werte der Benutzeroberfläche
        counterUI.setValue(0);
        /*
        counterUI.element.addEventListener('change', ((e: CustomEvent) => {
            console.log(e.detail);
        }) as EventListener);
        */
        // erstelle Audio
        bgMusic = new ƒ.Audio('sounds/tetrisMusic.mp3');
        audioCmp = new ƒ.ComponentAudio(bgMusic, true, false);
        audioCmp.connect(true);
        audioCmp.volume = 0.8;
        // Erstelle neues leeres Level
        createNewLevel();
        // erstelle Kamera
        const cmpCamera = new ƒ.ComponentCamera();
        cmpCamera.mtxPivot.translateZ(25);
        cmpCamera.mtxPivot.rotateY(180);
        // erstelle Viewport und initialisiere Szene
        Tetris.viewport = new ƒ.Viewport();
        Tetris.viewport.initialize('Viewport', graph, cmpCamera, canvas);
        Tetris.viewport.draw();
    }
    function handleStartClick() {
        startGame();
    }
    function handlePauseClick(ev) {
        const pauseBtn = ev.target;
        switch (gameState) {
            case GameState.RUNNING: {
                pauseGame();
                pauseBtn.innerText = 'Resume';
                break;
            }
            case GameState.PAUSED: {
                resumeGame();
                pauseBtn.innerText = 'Pause';
                break;
            }
        }
    }
    function handleMuteClick(ev) {
        const muteBtn = ev.target;
        if (isMuted) {
            isMuted = false;
            audioCmp.volume = 1;
            muteBtn.classList.remove('controls__button--start');
            muteBtn.innerText = 'Turn Off';
        }
        else {
            isMuted = true;
            audioCmp.volume = 0;
            muteBtn.classList.add('controls__button--start');
            muteBtn.innerText = 'Turn On';
        }
    }
    function handleDifficultyChange(ev) {
        const value = ev.target.value;
        gameDifficulty = value;
    }
    function startGame() {
        // STARTE SPIEL
        if (!audioCmp.isPlaying)
            audioCmp.play(true);
        // Erstelle neues leeres Level
        createNewLevel();
        // erstelle erste aktive Form
        setActiveShape();
        // setze input event listener
        document.addEventListener('keypress', control);
        // starte game loop
        console.log('START GAME');
        gameState = GameState.RUNNING;
        ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
        ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
    }
    function pauseGame() {
        if (gameState === GameState.RUNNING) {
            if (audioCmp.isPlaying)
                audioCmp.play(false);
            ƒ.Loop.stop();
            document.removeEventListener('keypress', control);
            gameState = GameState.PAUSED;
        }
    }
    function resumeGame() {
        if (gameState === GameState.PAUSED) {
            document.addEventListener('keypress', control);
            if (!audioCmp.isPlaying)
                audioCmp.play(true);
            ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
            ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
            gameState = GameState.RUNNING;
        }
    }
    function createNewLevel() {
        ƒ.Loop.stop();
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node('Graph');
        // Lösche alle Kindknoten des Graphs
        graph.removeAllChildren();
        // Wenn kein Level gesetzt wurde erstelle Wände und Boden
        if (!level) {
            level = {
                floor: Tetris.Shape.floor(15, new ƒ.Vector3(-6, -11, 0)),
                leftWall: Tetris.Shape.wall(23, new ƒ.Vector3(-8, -10, 0)),
                rightWall: Tetris.Shape.wall(23, new ƒ.Vector3(8, -10, 0)),
                round: 0,
            };
        }
        else {
            level.round += 1;
            counterUI.setValue(level.round);
        }
        graph.appendChild(level.floor);
        graph.appendChild(level.leftWall);
        graph.appendChild(level.rightWall);
        // leere Collider und füge Level-Collider hinzu
        colliders = [];
        colliders.push(level.floor);
        colliders.push(level.leftWall);
        colliders.push(level.rightWall);
    }
    function setActiveShape(shape) {
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node('Graph');
        // setze neue aktive Form
        activeShape = {
            form: shape || Tetris.Shape.random(),
            iteration: 0,
        };
        // füge Form zum Szenengraph hinzu
        graph.appendChild(activeShape.form);
    }
    function update(_event) {
        // ermittle zeitlich Differenz zum letzten Update
        const delta = Date.now() - lastUpdate;
        const gameInterval = gameData.difficulties[gameDifficulty].gameInterval;
        // teste of genug Zeit vergangen ist um das nächste Update zu starten
        // 600 = 600ms
        if (delta > gameInterval) {
            lastUpdate = Date.now();
            // Versuche Form nach unten zu bewegen
            if (!activeShape.form.tryMoveY(colliders)) {
                // Wenn Form mit einem Collider kollidiert
                // Prüfe ob dies bereits beim ersten Durchlauf passierte. Wenn ja ist das Spiel zu Ende,
                // das Level ist bis oben hin gefüllt
                if (activeShape.iteration <= 0) {
                    console.log('GAME OVER');
                    gameState = GameState.STOPPED;
                    // starte spiel neu
                    console.log('RESTART GAME');
                    startGame();
                    return;
                }
                // wenn nirgends angestoßen füge Form zu den anderen Collidern hinzu
                colliders.push(activeShape.form);
                // erstelle neue Form
                setActiveShape();
                Tetris.viewport.setBranch(graph);
            }
            else {
                activeShape.iteration += 1;
            }
        }
        Tetris.viewport.draw();
    }
    function control(_event) {
        let direction;
        let rotation;
        direction = ƒ.Keyboard.mapToValue(ƒ.Vector3.X(), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.D,
        ]);
        direction.add(ƒ.Keyboard.mapToValue(ƒ.Vector3.X(-1), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.A,
        ]));
        rotation = ƒ.Keyboard.mapToValue(1, 0, [ƒ.KEYBOARD_CODE.Q]);
        rotation += ƒ.Keyboard.mapToValue(-1, 0, [ƒ.KEYBOARD_CODE.E]);
        activeShape.form.moveX(direction);
        activeShape.form.rotateZ(rotation);
        Tetris.viewport.draw();
    }
})(Tetris || (Tetris = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXRyaXMvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxJQUFVLE1BQU0sQ0FpU2Y7QUFwU0Qsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxXQUFVLE1BQU07SUFDWixJQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7SUFlckIsSUFBSyxTQUlKO0lBSkQsV0FBSyxTQUFTO1FBQ1YsK0NBQU8sQ0FBQTtRQUNQLDZDQUFNLENBQUE7UUFDTiwrQ0FBTyxDQUFBO0lBQ1gsQ0FBQyxFQUpJLFNBQVMsS0FBVCxTQUFTLFFBSWI7SUFJRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRXpDLElBQUksS0FBYSxDQUFDO0lBQ2xCLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLFNBQVMsR0FBWSxFQUFFLENBQUM7SUFDNUIsSUFBSSxVQUFVLEdBQVcsQ0FBQyxDQUFDO0lBRTNCLElBQUksUUFBMEIsQ0FBQztJQUMvQixJQUFJLE9BQWdCLENBQUM7SUFDckIsSUFBSSxPQUFPLEdBQVksS0FBSyxDQUFDO0lBRTdCLElBQUksU0FBNEIsQ0FBQztJQUVqQyxJQUFJLEtBQVksQ0FBQztJQUNqQixJQUFJLFNBQVMsR0FBYyxTQUFTLENBQUMsT0FBTyxDQUFDO0lBQzdDLElBQUksUUFBYyxDQUFDO0lBQ25CLElBQUksY0FBYyxHQUFtQixRQUFRLENBQUM7SUFFOUMsS0FBSyxVQUFVLE9BQU8sQ0FBQyxNQUFhO1FBQ2hDLE1BQU0sTUFBTSxHQUFzQixRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRW5FLDJCQUEyQjtRQUMzQixNQUFNLFFBQVEsR0FDVixRQUFRLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXpDLE1BQU0sVUFBVSxHQUNaLFFBQVEsQ0FBQyxh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Q0FBQztRQUNuQyxPQUFBLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNwQixDQUFDO0FBQ0wsQ0FBQyxFQWpTUyxNQUFNLEtBQU4sTUFBTSxRQWlTZiIsInNvdXJjZXNDb250ZW50IjpbIi8vLzxyZWZlcmVuY2UgdHlwZXM9XCIuLi8uLi9GVURHRS9Db3JlL0Z1ZGdlQ29yZVwiLz5cclxuLy8vPHJlZmVyZW5jZSB0eXBlcz1cIi4uLy4uL0ZVREdFL1VzZXJJbnRlcmZhY2UvRnVkZ2VVc2VySW50ZXJmYWNlXCIvPlxyXG5cclxubmFtZXNwYWNlIFRldHJpcyB7XHJcbiAgICBpbXBvcnQgxpIgPSBGdWRnZUNvcmU7XHJcbiAgICAvLyBpbXBvcnQgxpJVSSA9IEZ1ZGdlVXNlckludGVyZmFjZTtcclxuXHJcbiAgICBpbnRlcmZhY2UgQWN0aXZlU2hhcGUge1xyXG4gICAgICAgIGZvcm06IFNoYXBlO1xyXG4gICAgICAgIGl0ZXJhdGlvbjogbnVtYmVyO1xyXG4gICAgfVxyXG5cclxuICAgIGludGVyZmFjZSBMZXZlbCB7XHJcbiAgICAgICAgZmxvb3I6IFNoYXBlO1xyXG4gICAgICAgIGxlZnRXYWxsOiBTaGFwZTtcclxuICAgICAgICByaWdodFdhbGw6IFNoYXBlO1xyXG4gICAgICAgIHJvdW5kOiBudW1iZXI7XHJcbiAgICB9XHJcblxyXG4gICAgZW51bSBHYW1lU3RhdGUge1xyXG4gICAgICAgIFJVTk5JTkcsXHJcbiAgICAgICAgUEFVU0VELFxyXG4gICAgICAgIFNUT1BQRUQsXHJcbiAgICB9XHJcblxyXG4gICAgdHlwZSBHYW1lRGlmZmljdWx0eSA9ICdlYXN5JyB8ICdtZWRpdW0nIHwgJ2hhcmQnO1xyXG5cclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgaG5kTG9hZCk7XHJcbiAgICBleHBvcnQgbGV0IHZpZXdwb3J0OiDGki5WaWV3cG9ydDtcclxuICAgIGxldCBncmFwaDogxpIuTm9kZTtcclxuICAgIGxldCBhY3RpdmVTaGFwZTogQWN0aXZlU2hhcGU7XHJcbiAgICBsZXQgY29sbGlkZXJzOiBTaGFwZVtdID0gW107XHJcbiAgICBsZXQgbGFzdFVwZGF0ZTogbnVtYmVyID0gMDtcclxuXHJcbiAgICBsZXQgYXVkaW9DbXA6IMaSLkNvbXBvbmVudEF1ZGlvO1xyXG4gICAgbGV0IGJnTXVzaWM6IMaSLkF1ZGlvO1xyXG4gICAgbGV0IGlzTXV0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICBsZXQgY291bnRlclVJOiBVSUVsZW1lbnQ8bnVtYmVyPjtcclxuXHJcbiAgICBsZXQgbGV2ZWw6IExldmVsO1xyXG4gICAgbGV0IGdhbWVTdGF0ZTogR2FtZVN0YXRlID0gR2FtZVN0YXRlLlNUT1BQRUQ7XHJcbiAgICBsZXQgZ2FtZURhdGE6IERhdGE7XHJcbiAgICBsZXQgZ2FtZURpZmZpY3VsdHk6IEdhbWVEaWZmaWN1bHR5ID0gJ21lZGl1bSc7XHJcblxyXG4gICAgYXN5bmMgZnVuY3Rpb24gaG5kTG9hZChfZXZlbnQ6IEV2ZW50KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2NhbnZhcycpO1xyXG5cclxuICAgICAgICAvKiogQ29udHJvbCBET00gRWxlbWVudHMgKi9cclxuICAgICAgICBjb25zdCBzdGFydEJ0bjogSFRNTEJ1dHRvbkVsZW1lbnQgPVxyXG4gICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjc3RhcnQtYnRuJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5ld0dhbWVCdG46IEhUTUxCdXR0b25FbGVtZW50ID1cclxuICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI25ldy1nYW1lLWJ0bicpO1xyXG5cclxuICAgICAgICBjb25zdCBtdXRlQnRuOiBIVE1MQnV0dG9uRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNtdXRlLWJ0bicpO1xyXG5cclxuICAgICAgICBjb25zdCBkaWZmaWN1bHR5U2VsZWN0OiBIVE1MU2VsZWN0RWxlbWVudCA9XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNkaWZmaWN1bHR5LXNlbGVjdCcpO1xyXG5cclxuICAgICAgICBjb3VudGVyVUkgPSBuZXcgVUlFbGVtZW50PG51bWJlcj4oJyNjb3VudGVyJyk7XHJcblxyXG4gICAgICAgIGlmIChuZXdHYW1lQnRuKSBuZXdHYW1lQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlU3RhcnRDbGljayk7XHJcbiAgICAgICAgaWYgKHN0YXJ0QnRuKSBzdGFydEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVBhdXNlQ2xpY2spO1xyXG4gICAgICAgIGlmIChtdXRlQnRuKSBtdXRlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlTXV0ZUNsaWNrKTtcclxuICAgICAgICBpZiAoZGlmZmljdWx0eVNlbGVjdCkge1xyXG4gICAgICAgICAgICBkaWZmaWN1bHR5U2VsZWN0LnZhbHVlID0gJ21lZGl1bSc7XHJcbiAgICAgICAgICAgIGRpZmZpY3VsdHlTZWxlY3QuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgaGFuZGxlRGlmZmljdWx0eUNoYW5nZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBzdG9yYWdlID0gbmV3IFN0b3JhZ2UoJy4vZGF0YS5qc29uJyk7XHJcbiAgICAgICAgYXdhaXQgc3RvcmFnZS5sb2FkRGF0YSgpO1xyXG4gICAgICAgIGdhbWVEYXRhID0gc3RvcmFnZS5nZXREYXRhKCk7XHJcblxyXG4gICAgICAgIC8vIHNldHplIFdlcnRlIGRlciBCZW51dHplcm9iZXJmbMOkY2hlXHJcbiAgICAgICAgY291bnRlclVJLnNldFZhbHVlKDApO1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgY291bnRlclVJLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKChlOiBDdXN0b21FdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlLmRldGFpbCk7XHJcbiAgICAgICAgfSkgYXMgRXZlbnRMaXN0ZW5lcik7XHJcbiAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgQXVkaW9cclxuICAgICAgICBiZ011c2ljID0gbmV3IMaSLkF1ZGlvKCdzb3VuZHMvdGV0cmlzTXVzaWMubXAzJyk7XHJcbiAgICAgICAgYXVkaW9DbXAgPSBuZXcgxpIuQ29tcG9uZW50QXVkaW8oYmdNdXNpYywgdHJ1ZSwgZmFsc2UpO1xyXG4gICAgICAgIGF1ZGlvQ21wLmNvbm5lY3QodHJ1ZSk7XHJcbiAgICAgICAgYXVkaW9DbXAudm9sdW1lID0gMC44O1xyXG5cclxuICAgICAgICAvLyBFcnN0ZWxsZSBuZXVlcyBsZWVyZXMgTGV2ZWxcclxuICAgICAgICBjcmVhdGVOZXdMZXZlbCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBLYW1lcmFcclxuICAgICAgICBjb25zdCBjbXBDYW1lcmE6IMaSLkNvbXBvbmVudENhbWVyYSA9IG5ldyDGki5Db21wb25lbnRDYW1lcmEoKTtcclxuICAgICAgICBjbXBDYW1lcmEubXR4UGl2b3QudHJhbnNsYXRlWigyNSk7XHJcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnJvdGF0ZVkoMTgwKTtcclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgVmlld3BvcnQgdW5kIGluaXRpYWxpc2llcmUgU3plbmVcclxuICAgICAgICB2aWV3cG9ydCA9IG5ldyDGki5WaWV3cG9ydCgpO1xyXG4gICAgICAgIHZpZXdwb3J0LmluaXRpYWxpemUoJ1ZpZXdwb3J0JywgZ3JhcGgsIGNtcENhbWVyYSwgY2FudmFzKTtcclxuICAgICAgICB2aWV3cG9ydC5kcmF3KCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlU3RhcnRDbGljaygpIHtcclxuICAgICAgICBzdGFydEdhbWUoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVQYXVzZUNsaWNrKGV2OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgcGF1c2VCdG4gPSBldi50YXJnZXQgYXMgSFRNTEJ1dHRvbkVsZW1lbnQ7XHJcblxyXG4gICAgICAgIHN3aXRjaCAoZ2FtZVN0YXRlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgR2FtZVN0YXRlLlJVTk5JTkc6IHtcclxuICAgICAgICAgICAgICAgIHBhdXNlR2FtZSgpO1xyXG4gICAgICAgICAgICAgICAgcGF1c2VCdG4uaW5uZXJUZXh0ID0gJ1Jlc3VtZSc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY2FzZSBHYW1lU3RhdGUuUEFVU0VEOiB7XHJcbiAgICAgICAgICAgICAgICByZXN1bWVHYW1lKCk7XHJcbiAgICAgICAgICAgICAgICBwYXVzZUJ0bi5pbm5lclRleHQgPSAnUGF1c2UnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlTXV0ZUNsaWNrKGV2OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgbXV0ZUJ0biA9IGV2LnRhcmdldCBhcyBIVE1MQnV0dG9uRWxlbWVudDtcclxuXHJcbiAgICAgICAgaWYgKGlzTXV0ZWQpIHtcclxuICAgICAgICAgICAgaXNNdXRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBhdWRpb0NtcC52b2x1bWUgPSAxO1xyXG4gICAgICAgICAgICBtdXRlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2NvbnRyb2xzX19idXR0b24tLXN0YXJ0Jyk7XHJcbiAgICAgICAgICAgIG11dGVCdG4uaW5uZXJUZXh0ID0gJ1R1cm4gT2ZmJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpc011dGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgYXVkaW9DbXAudm9sdW1lID0gMDtcclxuICAgICAgICAgICAgbXV0ZUJ0bi5jbGFzc0xpc3QuYWRkKCdjb250cm9sc19fYnV0dG9uLS1zdGFydCcpO1xyXG4gICAgICAgICAgICBtdXRlQnRuLmlubmVyVGV4dCA9ICdUdXJuIE9uJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlRGlmZmljdWx0eUNoYW5nZShldjogRXZlbnQpIHtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IChldi50YXJnZXQgYXMgSFRNTFNlbGVjdEVsZW1lbnQpLnZhbHVlIGFzIEdhbWVEaWZmaWN1bHR5O1xyXG4gICAgICAgIGdhbWVEaWZmaWN1bHR5ID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3RhcnRHYW1lKCkge1xyXG4gICAgICAgIC8vIFNUQVJURSBTUElFTFxyXG4gICAgICAgIGlmICghYXVkaW9DbXAuaXNQbGF5aW5nKSBhdWRpb0NtcC5wbGF5KHRydWUpO1xyXG5cclxuICAgICAgICAvLyBFcnN0ZWxsZSBuZXVlcyBsZWVyZXMgTGV2ZWxcclxuICAgICAgICBjcmVhdGVOZXdMZXZlbCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBlcnN0ZSBha3RpdmUgRm9ybVxyXG4gICAgICAgIHNldEFjdGl2ZVNoYXBlKCk7XHJcblxyXG4gICAgICAgIC8vIHNldHplIGlucHV0IGV2ZW50IGxpc3RlbmVyXHJcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5cHJlc3MnLCBjb250cm9sKTtcclxuXHJcbiAgICAgICAgLy8gc3RhcnRlIGdhbWUgbG9vcFxyXG4gICAgICAgIGNvbnNvbGUubG9nKCdTVEFSVCBHQU1FJyk7XHJcbiAgICAgICAgZ2FtZVN0YXRlID0gR2FtZVN0YXRlLlJVTk5JTkc7XHJcbiAgICAgICAgxpIuTG9vcC5hZGRFdmVudExpc3RlbmVyKMaSLkVWRU5ULkxPT1BfRlJBTUUsIHVwZGF0ZSk7XHJcbiAgICAgICAgxpIuTG9vcC5zdGFydCjGki5MT09QX01PREUuVElNRV9SRUFMKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwYXVzZUdhbWUoKSB7XHJcbiAgICAgICAgaWYgKGdhbWVTdGF0ZSA9PT0gR2FtZVN0YXRlLlJVTk5JTkcpIHtcclxuICAgICAgICAgICAgaWYgKGF1ZGlvQ21wLmlzUGxheWluZykgYXVkaW9DbXAucGxheShmYWxzZSk7XHJcbiAgICAgICAgICAgIMaSLkxvb3Auc3RvcCgpO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIGNvbnRyb2wpO1xyXG4gICAgICAgICAgICBnYW1lU3RhdGUgPSBHYW1lU3RhdGUuUEFVU0VEO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZXN1bWVHYW1lKCkge1xyXG4gICAgICAgIGlmIChnYW1lU3RhdGUgPT09IEdhbWVTdGF0ZS5QQVVTRUQpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5cHJlc3MnLCBjb250cm9sKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghYXVkaW9DbXAuaXNQbGF5aW5nKSBhdWRpb0NtcC5wbGF5KHRydWUpO1xyXG4gICAgICAgICAgICDGki5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoxpIuRVZFTlQuTE9PUF9GUkFNRSwgdXBkYXRlKTtcclxuICAgICAgICAgICAgxpIuTG9vcC5zdGFydCjGki5MT09QX01PREUuVElNRV9SRUFMKTtcclxuICAgICAgICAgICAgZ2FtZVN0YXRlID0gR2FtZVN0YXRlLlJVTk5JTkc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZU5ld0xldmVsKCkge1xyXG4gICAgICAgIMaSLkxvb3Auc3RvcCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBTemVuZW5ncmFwaCAoV3VyemVsa25vdGVuKSB3ZW5uIG7DtnRpZ1xyXG4gICAgICAgIGlmICghZ3JhcGgpIGdyYXBoID0gbmV3IMaSLk5vZGUoJ0dyYXBoJyk7XHJcblxyXG4gICAgICAgIC8vIEzDtnNjaGUgYWxsZSBLaW5ka25vdGVuIGRlcyBHcmFwaHNcclxuICAgICAgICBncmFwaC5yZW1vdmVBbGxDaGlsZHJlbigpO1xyXG5cclxuICAgICAgICAvLyBXZW5uIGtlaW4gTGV2ZWwgZ2VzZXR6dCB3dXJkZSBlcnN0ZWxsZSBXw6RuZGUgdW5kIEJvZGVuXHJcbiAgICAgICAgaWYgKCFsZXZlbCkge1xyXG4gICAgICAgICAgICBsZXZlbCA9IHtcclxuICAgICAgICAgICAgICAgIGZsb29yOiBTaGFwZS5mbG9vcigxNSwgbmV3IMaSLlZlY3RvcjMoLTYsIC0xMSwgMCkpLFxyXG4gICAgICAgICAgICAgICAgbGVmdFdhbGw6IFNoYXBlLndhbGwoMjMsIG5ldyDGki5WZWN0b3IzKC04LCAtMTAsIDApKSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0V2FsbDogU2hhcGUud2FsbCgyMywgbmV3IMaSLlZlY3RvcjMoOCwgLTEwLCAwKSksXHJcbiAgICAgICAgICAgICAgICByb3VuZDogMCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXZlbC5yb3VuZCArPSAxO1xyXG4gICAgICAgICAgICBjb3VudGVyVUkuc2V0VmFsdWUobGV2ZWwucm91bmQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JhcGguYXBwZW5kQ2hpbGQobGV2ZWwuZmxvb3IpO1xyXG4gICAgICAgIGdyYXBoLmFwcGVuZENoaWxkKGxldmVsLmxlZnRXYWxsKTtcclxuICAgICAgICBncmFwaC5hcHBlbmRDaGlsZChsZXZlbC5yaWdodFdhbGwpO1xyXG5cclxuICAgICAgICAvLyBsZWVyZSBDb2xsaWRlciB1bmQgZsO8Z2UgTGV2ZWwtQ29sbGlkZXIgaGluenVcclxuICAgICAgICBjb2xsaWRlcnMgPSBbXTtcclxuICAgICAgICBjb2xsaWRlcnMucHVzaChsZXZlbC5mbG9vcik7XHJcbiAgICAgICAgY29sbGlkZXJzLnB1c2gobGV2ZWwubGVmdFdhbGwpO1xyXG4gICAgICAgIGNvbGxpZGVycy5wdXNoKGxldmVsLnJpZ2h0V2FsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2V0QWN0aXZlU2hhcGUoc2hhcGU/OiBTaGFwZSkge1xyXG4gICAgICAgIC8vIGVyc3RlbGxlIFN6ZW5lbmdyYXBoIChXdXJ6ZWxrbm90ZW4pIHdlbm4gbsO2dGlnXHJcbiAgICAgICAgaWYgKCFncmFwaCkgZ3JhcGggPSBuZXcgxpIuTm9kZSgnR3JhcGgnKTtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgbmV1ZSBha3RpdmUgRm9ybVxyXG4gICAgICAgIGFjdGl2ZVNoYXBlID0ge1xyXG4gICAgICAgICAgICBmb3JtOiBzaGFwZSB8fCBTaGFwZS5yYW5kb20oKSxcclxuICAgICAgICAgICAgaXRlcmF0aW9uOiAwLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIGbDvGdlIEZvcm0genVtIFN6ZW5lbmdyYXBoIGhpbnp1XHJcbiAgICAgICAgZ3JhcGguYXBwZW5kQ2hpbGQoYWN0aXZlU2hhcGUuZm9ybSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlKF9ldmVudDogxpIuRXZlbnTGkik6IHZvaWQge1xyXG4gICAgICAgIC8vIGVybWl0dGxlIHplaXRsaWNoIERpZmZlcmVueiB6dW0gbGV0enRlbiBVcGRhdGVcclxuICAgICAgICBjb25zdCBkZWx0YSA9IERhdGUubm93KCkgLSBsYXN0VXBkYXRlO1xyXG4gICAgICAgIGNvbnN0IGdhbWVJbnRlcnZhbCA9IGdhbWVEYXRhLmRpZmZpY3VsdGllc1tnYW1lRGlmZmljdWx0eV0uZ2FtZUludGVydmFsO1xyXG5cclxuICAgICAgICAvLyB0ZXN0ZSBvZiBnZW51ZyBaZWl0IHZlcmdhbmdlbiBpc3QgdW0gZGFzIG7DpGNoc3RlIFVwZGF0ZSB6dSBzdGFydGVuXHJcbiAgICAgICAgLy8gNjAwID0gNjAwbXNcclxuICAgICAgICBpZiAoZGVsdGEgPiBnYW1lSW50ZXJ2YWwpIHtcclxuICAgICAgICAgICAgbGFzdFVwZGF0ZSA9IERhdGUubm93KCk7XHJcblxyXG4gICAgICAgICAgICAvLyBWZXJzdWNoZSBGb3JtIG5hY2ggdW50ZW4genUgYmV3ZWdlblxyXG4gICAgICAgICAgICBpZiAoIWFjdGl2ZVNoYXBlLmZvcm0udHJ5TW92ZVkoY29sbGlkZXJzKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gV2VubiBGb3JtIG1pdCBlaW5lbSBDb2xsaWRlciBrb2xsaWRpZXJ0XHJcbiAgICAgICAgICAgICAgICAvLyBQcsO8ZmUgb2IgZGllcyBiZXJlaXRzIGJlaW0gZXJzdGVuIER1cmNobGF1ZiBwYXNzaWVydGUuIFdlbm4gamEgaXN0IGRhcyBTcGllbCB6dSBFbmRlLFxyXG4gICAgICAgICAgICAgICAgLy8gZGFzIExldmVsIGlzdCBiaXMgb2JlbiBoaW4gZ2Vmw7xsbHRcclxuICAgICAgICAgICAgICAgIGlmIChhY3RpdmVTaGFwZS5pdGVyYXRpb24gPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdHQU1FIE9WRVInKTtcclxuICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUgPSBHYW1lU3RhdGUuU1RPUFBFRDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc3RhcnRlIHNwaWVsIG5ldVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdSRVNUQVJUIEdBTUUnKTtcclxuICAgICAgICAgICAgICAgICAgICBzdGFydEdhbWUoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIHdlbm4gbmlyZ2VuZHMgYW5nZXN0b8OfZW4gZsO8Z2UgRm9ybSB6dSBkZW4gYW5kZXJlbiBDb2xsaWRlcm4gaGluenVcclxuICAgICAgICAgICAgICAgIGNvbGxpZGVycy5wdXNoKGFjdGl2ZVNoYXBlLmZvcm0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGVyc3RlbGxlIG5ldWUgRm9ybVxyXG4gICAgICAgICAgICAgICAgc2V0QWN0aXZlU2hhcGUoKTtcclxuICAgICAgICAgICAgICAgIHZpZXdwb3J0LnNldEJyYW5jaChncmFwaCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVTaGFwZS5pdGVyYXRpb24gKz0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmlld3BvcnQuZHJhdygpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNvbnRyb2woX2V2ZW50OiBFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGxldCBkaXJlY3Rpb246IMaSLlZlY3RvcjM7XHJcbiAgICAgICAgbGV0IHJvdGF0aW9uOiBudW1iZXI7XHJcblxyXG4gICAgICAgIGRpcmVjdGlvbiA9IMaSLktleWJvYXJkLm1hcFRvVmFsdWUoxpIuVmVjdG9yMy5YKCksIMaSLlZlY3RvcjMuWkVSTygpLCBbXHJcbiAgICAgICAgICAgIMaSLktFWUJPQVJEX0NPREUuRCxcclxuICAgICAgICBdKTtcclxuICAgICAgICBkaXJlY3Rpb24uYWRkKFxyXG4gICAgICAgICAgICDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKMaSLlZlY3RvcjMuWCgtMSksIMaSLlZlY3RvcjMuWkVSTygpLCBbXHJcbiAgICAgICAgICAgICAgICDGki5LRVlCT0FSRF9DT0RFLkEsXHJcbiAgICAgICAgICAgIF0pXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgcm90YXRpb24gPSDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKDEsIDAsIFvGki5LRVlCT0FSRF9DT0RFLlFdKTtcclxuICAgICAgICByb3RhdGlvbiArPSDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKC0xLCAwLCBbxpIuS0VZQk9BUkRfQ09ERS5FXSk7XHJcblxyXG4gICAgICAgIGFjdGl2ZVNoYXBlLmZvcm0ubW92ZVgoZGlyZWN0aW9uKTtcclxuICAgICAgICBhY3RpdmVTaGFwZS5mb3JtLnJvdGF0ZVoocm90YXRpb24pO1xyXG4gICAgICAgIHZpZXdwb3J0LmRyYXcoKTtcclxuICAgIH1cclxufVxyXG4iXX0=