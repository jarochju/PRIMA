"use strict";
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
var Tetris;
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
(function (Tetris) {
    var ƒ = FudgeCore;
    window.addEventListener('load', hndLoad);
    let graph;
    let activeShape;
    let colliders = [];
    let lastUpdate = 0;
    let audioCmp;
    let bgMusic;
    let speed;
    let counterUI;
    let level;
    async function hndLoad(_event) {
        const canvas = document.querySelector('canvas');
        counterUI = new Tetris.UIElement('#counter');
        const storage = new Tetris.Storage('./data.json');
        await storage.loadData();
        const { gameInterval } = storage.getData();
        speed = gameInterval;
        // setze Werte der Benutzeroberfläche
        counterUI.setValue(0);
        /*
        counterUI.element.addEventListener('change', ((e: CustomEvent) => {
            console.log(e.detail);
        }) as EventListener);
        */
        // erstelle Level
        createNewLevel();
        // erstelle Audio
        bgMusic = new ƒ.Audio('sounds/tetrisMusic.mp3');
        audioCmp = new ƒ.ComponentAudio(bgMusic, true, false);
        audioCmp.connect(true);
        audioCmp.volume = 0.8;
        // erstelle Kamera
        const cmpCamera = new ƒ.ComponentCamera();
        cmpCamera.mtxPivot.translateZ(25);
        cmpCamera.mtxPivot.rotateY(180);
        // erstelle Viewport und initialisiere Szene
        Tetris.viewport = new ƒ.Viewport();
        Tetris.viewport.initialize('Viewport', graph, cmpCamera, canvas);
        // STARTE SPIEL
        // erstelle erste aktive Form
        setActiveShape();
        // setze input event listener
        document.addEventListener('keypress', control);
        // starte game loop
        console.log('START GAME');
        ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
        ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
    }
    function createNewLevel() {
        ƒ.Loop.stop();
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node('Graph');
        // Lösche alle Kindknoten des Graphs
        graph.removeAllChildren();
        // Wenn kein Level gesetzt wurde erstelle Wände und Boden
        if (!level) {
            level = {
                floor: Tetris.Shape.floor(15, new ƒ.Vector3(-6, -11, 0)),
                leftWall: Tetris.Shape.wall(23, new ƒ.Vector3(-8, -10, 0)),
                rightWall: Tetris.Shape.wall(23, new ƒ.Vector3(8, -10, 0)),
                round: 0,
            };
        }
        else {
            level.round += 1;
            counterUI.setValue(level.round);
        }
        graph.appendChild(level.floor);
        graph.appendChild(level.leftWall);
        graph.appendChild(level.rightWall);
        // leere Collider und füge Level-Collider hinzu
        colliders = [];
        colliders.push(level.floor);
        colliders.push(level.leftWall);
        colliders.push(level.rightWall);
    }
    function setActiveShape(shape) {
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node('Graph');
        // setze neue aktive Form
        activeShape = {
            form: shape || Tetris.Shape.random(),
            iteration: 0,
        };
        // füge Form zum Szenengraph hinzu
        graph.appendChild(activeShape.form);
    }
    function update(_event) {
        // ermittle zeitlich Differenz zum letzten Update
        const delta = Date.now() - lastUpdate;
        // teste of genug Zeit vergangen ist um das nächste Update zu starten
        // 600 = 600ms
        if (delta > speed) {
            lastUpdate = Date.now();
            // Versuche Form nach unten zu bewegen
            if (!activeShape.form.tryMoveY(colliders)) {
                // Wenn Form mit einem Collider kollidiert
                // Prüfe ob dies bereits beim ersten Durchlauf passierte. Wenn ja ist das Spiel zu Ende,
                // das Level ist bis oben hin gefüllt
                if (activeShape.iteration <= 0) {
                    console.log('GAME OVER');
                    // Erstelle neues leeres Level
                    createNewLevel();
                    // setze neue Form
                    setActiveShape();
                    // starte spiel neu
                    console.log('RESTART GAME');
                    ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
                    ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
                    return;
                }
                // wenn nirgends angestoßen füge Form zu den anderen Collidern hinzu
                colliders.push(activeShape.form);
                // erstelle neue Form
                setActiveShape();
                Tetris.viewport.setBranch(graph);
            }
            else {
                activeShape.iteration += 1;
            }
        }
        Tetris.viewport.draw();
    }
    function control(_event) {
        let direction;
        let rotation;
        // Temporärer Einstieg der Musik. Browser benötigt Nutzerinteraktion bevor er Musik starten kann
        if (!audioCmp.isPlaying)
            audioCmp.play(true);
        direction = ƒ.Keyboard.mapToValue(ƒ.Vector3.X(), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.D,
        ]);
        direction.add(ƒ.Keyboard.mapToValue(ƒ.Vector3.X(-1), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.A,
        ]));
        rotation = ƒ.Keyboard.mapToValue(1, 0, [ƒ.KEYBOARD_CODE.Q]);
        rotation += ƒ.Keyboard.mapToValue(-1, 0, [ƒ.KEYBOARD_CODE.E]);
        activeShape.form.moveX(direction);
        activeShape.form.rotateZ(rotation);
        Tetris.viewport.draw();
    }
})(Tetris || (Tetris = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXRyaXMvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxJQUFVLE1BQU0sQ0FpTWY7QUFwTUQsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxXQUFVLE1BQU07SUFDWixJQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7SUFlckIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUV6QyxJQUFJLEtBQWEsQ0FBQztJQUNsQixJQUFJLFdBQXdCLENBQUM7SUFDN0IsSUFBSSxTQUFTLEdBQVksRUFBRSxDQUFDO0lBQzVCLElBQUksVUFBVSxHQUFXLENBQUMsQ0FBQztJQUUzQixJQUFJLFFBQTBCLENBQUM7SUFDL0IsSUFBSSxPQUFnQixDQUFDO0lBQ3JCLElBQUksS0FBYSxDQUFDO0lBRWxCLElBQUksU0FBNEIsQ0FBQztJQUVqQyxJQUFJLEtBQVksQ0FBQztJQUNqQixLQUFLLFVBQVUsT0FBTyxDQUFDLE1BQWE7UUFDaEMsTUFBTSxNQUFNLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkUsU0FBUyxHQUFHLElBQUksT0FBQSxTQUFTLENBQVMsVUFBVSxDQUFDLENBQUM7UUFFOUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxPQUFBLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzQyxNQUFNLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QixNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzNDLEtBQUssR0FBRyxZQUFZLENBQUM7UUFFckIscUNBQXFDO1FBQ3JDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEI7Ozs7VUFJRTtRQUVGLGlCQUFpQjtRQUNqQixjQUFjLEVB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RTtZQUNyRCxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDcEIsQ0FBQyxDQUNMLENBQUM7UUFFRixRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1RCxRQUFRLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTlELFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2xDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25DLE9BQUEsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3BCLENBQUM7QUFDTCxDQUFDLEVBak1TLE1BQU0sS0FBTixNQUFNLFFBaU1mIiwic291cmNlc0NvbnRlbnQiOlsiLy8vPHJlZmVyZW5jZSB0eXBlcz1cIi4uLy4uL0ZVREdFL0NvcmUvRnVkZ2VDb3JlXCIvPlxyXG4vLy88cmVmZXJlbmNlIHR5cGVzPVwiLi4vLi4vRlVER0UvVXNlckludGVyZmFjZS9GdWRnZVVzZXJJbnRlcmZhY2VcIi8+XHJcblxyXG5uYW1lc3BhY2UgVGV0cmlzIHtcclxuICAgIGltcG9ydCDGkiA9IEZ1ZGdlQ29yZTtcclxuICAgIC8vIGltcG9ydCDGklVJID0gRnVkZ2VVc2VySW50ZXJmYWNlO1xyXG5cclxuICAgIGludGVyZmFjZSBBY3RpdmVTaGFwZSB7XHJcbiAgICAgICAgZm9ybTogU2hhcGU7XHJcbiAgICAgICAgaXRlcmF0aW9uOiBudW1iZXI7XHJcbiAgICB9XHJcblxyXG4gICAgaW50ZXJmYWNlIExldmVsIHtcclxuICAgICAgICBmbG9vcjogU2hhcGU7XHJcbiAgICAgICAgbGVmdFdhbGw6IFNoYXBlO1xyXG4gICAgICAgIHJpZ2h0V2FsbDogU2hhcGU7XHJcbiAgICAgICAgcm91bmQ6IG51bWJlcjtcclxuICAgIH1cclxuXHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGhuZExvYWQpO1xyXG4gICAgZXhwb3J0IGxldCB2aWV3cG9ydDogxpIuVmlld3BvcnQ7XHJcbiAgICBsZXQgZ3JhcGg6IMaSLk5vZGU7XHJcbiAgICBsZXQgYWN0aXZlU2hhcGU6IEFjdGl2ZVNoYXBlO1xyXG4gICAgbGV0IGNvbGxpZGVyczogU2hhcGVbXSA9IFtdO1xyXG4gICAgbGV0IGxhc3RVcGRhdGU6IG51bWJlciA9IDA7XHJcblxyXG4gICAgbGV0IGF1ZGlvQ21wOiDGki5Db21wb25lbnRBdWRpbztcclxuICAgIGxldCBiZ011c2ljOiDGki5BdWRpbztcclxuICAgIGxldCBzcGVlZDogbnVtYmVyO1xyXG5cclxuICAgIGxldCBjb3VudGVyVUk6IFVJRWxlbWVudDxudW1iZXI+O1xyXG5cclxuICAgIGxldCBsZXZlbDogTGV2ZWw7XHJcbiAgICBhc3luYyBmdW5jdGlvbiBobmRMb2FkKF9ldmVudDogRXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignY2FudmFzJyk7XHJcbiAgICAgICAgY291bnRlclVJID0gbmV3IFVJRWxlbWVudDxudW1iZXI+KCcjY291bnRlcicpO1xyXG5cclxuICAgICAgICBjb25zdCBzdG9yYWdlID0gbmV3IFN0b3JhZ2UoJy4vZGF0YS5qc29uJyk7XHJcbiAgICAgICAgYXdhaXQgc3RvcmFnZS5sb2FkRGF0YSgpO1xyXG4gICAgICAgIGNvbnN0IHsgZ2FtZUludGVydmFsIH0gPSBzdG9yYWdlLmdldERhdGEoKTtcclxuICAgICAgICBzcGVlZCA9IGdhbWVJbnRlcnZhbDtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgV2VydGUgZGVyIEJlbnV0emVyb2JlcmZsw6RjaGVcclxuICAgICAgICBjb3VudGVyVUkuc2V0VmFsdWUoMCk7XHJcbiAgICAgICAgLypcclxuICAgICAgICBjb3VudGVyVUkuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKGU6IEN1c3RvbUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUuZGV0YWlsKTtcclxuICAgICAgICB9KSBhcyBFdmVudExpc3RlbmVyKTtcclxuICAgICAgICAqL1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBMZXZlbFxyXG4gICAgICAgIGNyZWF0ZU5ld0xldmVsKCk7XHJcblxyXG4gICAgICAgIC8vIGVyc3RlbGxlIEF1ZGlvXHJcbiAgICAgICAgYmdNdXNpYyA9IG5ldyDGki5BdWRpbygnc291bmRzL3RldHJpc011c2ljLm1wMycpO1xyXG4gICAgICAgIGF1ZGlvQ21wID0gbmV3IMaSLkNvbXBvbmVudEF1ZGlvKGJnTXVzaWMsIHRydWUsIGZhbHNlKTtcclxuICAgICAgICBhdWRpb0NtcC5jb25uZWN0KHRydWUpO1xyXG4gICAgICAgIGF1ZGlvQ21wLnZvbHVtZSA9IDAuODtcclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgS2FtZXJhXHJcbiAgICAgICAgY29uc3QgY21wQ2FtZXJhOiDGki5Db21wb25lbnRDYW1lcmEgPSBuZXcgxpIuQ29tcG9uZW50Q2FtZXJhKCk7XHJcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnRyYW5zbGF0ZVooMjUpO1xyXG4gICAgICAgIGNtcENhbWVyYS5tdHhQaXZvdC5yb3RhdGVZKDE4MCk7XHJcblxyXG4gICAgICAgIC8vIGVyc3RlbGxlIFZpZXdwb3J0IHVuZCBpbml0aWFsaXNpZXJlIFN6ZW5lXHJcbiAgICAgICAgdmlld3BvcnQgPSBuZXcgxpIuVmlld3BvcnQoKTtcclxuICAgICAgICB2aWV3cG9ydC5pbml0aWFsaXplKCdWaWV3cG9ydCcsIGdyYXBoLCBjbXBDYW1lcmEsIGNhbnZhcyk7XHJcblxyXG4gICAgICAgIC8vIFNUQVJURSBTUElFTFxyXG4gICAgICAgIC8vIGVyc3RlbGxlIGVyc3RlIGFrdGl2ZSBGb3JtXHJcbiAgICAgICAgc2V0QWN0aXZlU2hhcGUoKTtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgaW5wdXQgZXZlbnQgbGlzdGVuZXJcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIGNvbnRyb2wpO1xyXG5cclxuICAgICAgICAvLyBzdGFydGUgZ2FtZSBsb29wXHJcbiAgICAgICAgY29uc29sZS5sb2coJ1NUQVJUIEdBTUUnKTtcclxuICAgICAgICDGki5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoxpIuRVZFTlQuTE9PUF9GUkFNRSwgdXBkYXRlKTtcclxuICAgICAgICDGki5Mb29wLnN0YXJ0KMaSLkxPT1BfTU9ERS5USU1FX1JFQUwpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZU5ld0xldmVsKCkge1xyXG4gICAgICAgIMaSLkxvb3Auc3RvcCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBTemVuZW5ncmFwaCAoV3VyemVsa25vdGVuKSB3ZW5uIG7DtnRpZ1xyXG4gICAgICAgIGlmICghZ3JhcGgpIGdyYXBoID0gbmV3IMaSLk5vZGUoJ0dyYXBoJyk7XHJcblxyXG4gICAgICAgIC8vIEzDtnNjaGUgYWxsZSBLaW5ka25vdGVuIGRlcyBHcmFwaHNcclxuICAgICAgICBncmFwaC5yZW1vdmVBbGxDaGlsZHJlbigpO1xyXG5cclxuICAgICAgICAvLyBXZW5uIGtlaW4gTGV2ZWwgZ2VzZXR6dCB3dXJkZSBlcnN0ZWxsZSBXw6RuZGUgdW5kIEJvZGVuXHJcbiAgICAgICAgaWYgKCFsZXZlbCkge1xyXG4gICAgICAgICAgICBsZXZlbCA9IHtcclxuICAgICAgICAgICAgICAgIGZsb29yOiBTaGFwZS5mbG9vcigxNSwgbmV3IMaSLlZlY3RvcjMoLTYsIC0xMSwgMCkpLFxyXG4gICAgICAgICAgICAgICAgbGVmdFdhbGw6IFNoYXBlLndhbGwoMjMsIG5ldyDGki5WZWN0b3IzKC04LCAtMTAsIDApKSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0V2FsbDogU2hhcGUud2FsbCgyMywgbmV3IMaSLlZlY3RvcjMoOCwgLTEwLCAwKSksXHJcbiAgICAgICAgICAgICAgICByb3VuZDogMCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXZlbC5yb3VuZCArPSAxO1xyXG4gICAgICAgICAgICBjb3VudGVyVUkuc2V0VmFsdWUobGV2ZWwucm91bmQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JhcGguYXBwZW5kQ2hpbGQobGV2ZWwuZmxvb3IpO1xyXG4gICAgICAgIGdyYXBoLmFwcGVuZENoaWxkKGxldmVsLmxlZnRXYWxsKTtcclxuICAgICAgICBncmFwaC5hcHBlbmRDaGlsZChsZXZlbC5yaWdodFdhbGwpO1xyXG5cclxuICAgICAgICAvLyBsZWVyZSBDb2xsaWRlciB1bmQgZsO8Z2UgTGV2ZWwtQ29sbGlkZXIgaGluenVcclxuICAgICAgICBjb2xsaWRlcnMgPSBbXTtcclxuICAgICAgICBjb2xsaWRlcnMucHVzaChsZXZlbC5mbG9vcik7XHJcbiAgICAgICAgY29sbGlkZXJzLnB1c2gobGV2ZWwubGVmdFdhbGwpO1xyXG4gICAgICAgIGNvbGxpZGVycy5wdXNoKGxldmVsLnJpZ2h0V2FsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2V0QWN0aXZlU2hhcGUoc2hhcGU/OiBTaGFwZSkge1xyXG4gICAgICAgIC8vIGVyc3RlbGxlIFN6ZW5lbmdyYXBoIChXdXJ6ZWxrbm90ZW4pIHdlbm4gbsO2dGlnXHJcbiAgICAgICAgaWYgKCFncmFwaCkgZ3JhcGggPSBuZXcgxpIuTm9kZSgnR3JhcGgnKTtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgbmV1ZSBha3RpdmUgRm9ybVxyXG4gICAgICAgIGFjdGl2ZVNoYXBlID0ge1xyXG4gICAgICAgICAgICBmb3JtOiBzaGFwZSB8fCBTaGFwZS5yYW5kb20oKSxcclxuICAgICAgICAgICAgaXRlcmF0aW9uOiAwLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIGbDvGdlIEZvcm0genVtIFN6ZW5lbmdyYXBoIGhpbnp1XHJcbiAgICAgICAgZ3JhcGguYXBwZW5kQ2hpbGQoYWN0aXZlU2hhcGUuZm9ybSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlKF9ldmVudDogxpIuRXZlbnTGkik6IHZvaWQge1xyXG4gICAgICAgIC8vIGVybWl0dGxlIHplaXRsaWNoIERpZmZlcmVueiB6dW0gbGV0enRlbiBVcGRhdGVcclxuICAgICAgICBjb25zdCBkZWx0YSA9IERhdGUubm93KCkgLSBsYXN0VXBkYXRlO1xyXG5cclxuICAgICAgICAvLyB0ZXN0ZSBvZiBnZW51ZyBaZWl0IHZlcmdhbmdlbiBpc3QgdW0gZGFzIG7DpGNoc3RlIFVwZGF0ZSB6dSBzdGFydGVuXHJcbiAgICAgICAgLy8gNjAwID0gNjAwbXNcclxuICAgICAgICBpZiAoZGVsdGEgPiBzcGVlZCkge1xyXG4gICAgICAgICAgICBsYXN0VXBkYXRlID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFZlcnN1Y2hlIEZvcm0gbmFjaCB1bnRlbiB6dSBiZXdlZ2VuXHJcbiAgICAgICAgICAgIGlmICghYWN0aXZlU2hhcGUuZm9ybS50cnlNb3ZlWShjb2xsaWRlcnMpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBXZW5uIEZvcm0gbWl0IGVpbmVtIENvbGxpZGVyIGtvbGxpZGllcnRcclxuICAgICAgICAgICAgICAgIC8vIFByw7xmZSBvYiBkaWVzIGJlcmVpdHMgYmVpbSBlcnN0ZW4gRHVyY2hsYXVmIHBhc3NpZXJ0ZS4gV2VubiBqYSBpc3QgZGFzIFNwaWVsIHp1IEVuZGUsXHJcbiAgICAgICAgICAgICAgICAvLyBkYXMgTGV2ZWwgaXN0IGJpcyBvYmVuIGhpbiBnZWbDvGxsdFxyXG4gICAgICAgICAgICAgICAgaWYgKGFjdGl2ZVNoYXBlLml0ZXJhdGlvbiA8PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0dBTUUgT1ZFUicpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBFcnN0ZWxsZSBuZXVlcyBsZWVyZXMgTGV2ZWxcclxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVOZXdMZXZlbCgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzZXR6ZSBuZXVlIEZvcm1cclxuICAgICAgICAgICAgICAgICAgICBzZXRBY3RpdmVTaGFwZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzdGFydGUgc3BpZWwgbmV1XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1JFU1RBUlQgR0FNRScpO1xyXG4gICAgICAgICAgICAgICAgICAgIMaSLkxvb3AuYWRkRXZlbnRMaXN0ZW5lcijGki5FVkVOVC5MT09QX0ZSQU1FLCB1cGRhdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIMaSLkxvb3Auc3RhcnQoxpIuTE9PUF9NT0RFLlRJTUVfUkVBTCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyB3ZW5uIG5pcmdlbmRzIGFuZ2VzdG/Dn2VuIGbDvGdlIEZvcm0genUgZGVuIGFuZGVyZW4gQ29sbGlkZXJuIGhpbnp1XHJcbiAgICAgICAgICAgICAgICBjb2xsaWRlcnMucHVzaChhY3RpdmVTaGFwZS5mb3JtKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBlcnN0ZWxsZSBuZXVlIEZvcm1cclxuICAgICAgICAgICAgICAgIHNldEFjdGl2ZVNoYXBlKCk7XHJcbiAgICAgICAgICAgICAgICB2aWV3cG9ydC5zZXRCcmFuY2goZ3JhcGgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZlU2hhcGUuaXRlcmF0aW9uICs9IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHZpZXdwb3J0LmRyYXcoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjb250cm9sKF9ldmVudDogRXZlbnQpOiB2b2lkIHtcclxuICAgICAgICBsZXQgZGlyZWN0aW9uOiDGki5WZWN0b3IzO1xyXG4gICAgICAgIGxldCByb3RhdGlvbjogbnVtYmVyO1xyXG5cclxuICAgICAgICAvLyBUZW1wb3LDpHJlciBFaW5zdGllZyBkZXIgTXVzaWsuIEJyb3dzZXIgYmVuw7Z0aWd0IE51dHplcmludGVyYWt0aW9uIGJldm9yIGVyIE11c2lrIHN0YXJ0ZW4ga2FublxyXG4gICAgICAgIGlmICghYXVkaW9DbXAuaXNQbGF5aW5nKSBhdWRpb0NtcC5wbGF5KHRydWUpO1xyXG5cclxuICAgICAgICBkaXJlY3Rpb24gPSDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKMaSLlZlY3RvcjMuWCgpLCDGki5WZWN0b3IzLlpFUk8oKSwgW1xyXG4gICAgICAgICAgICDGki5LRVlCT0FSRF9DT0RFLkQsXHJcbiAgICAgICAgXSk7XHJcbiAgICAgICAgZGlyZWN0aW9uLmFkZChcclxuICAgICAgICAgICAgxpIuS2V5Ym9hcmQubWFwVG9WYWx1ZSjGki5WZWN0b3IzLlgoLTEpLCDGki5WZWN0b3IzLlpFUk8oKSwgW1xyXG4gICAgICAgICAgICAgICAgxpIuS0VZQk9BUkRfQ09ERS5BLFxyXG4gICAgICAgICAgICBdKVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHJvdGF0aW9uID0gxpIuS2V5Ym9hcmQubWFwVG9WYWx1ZSgxLCAwLCBbxpIuS0VZQk9BUkRfQ09ERS5RXSk7XHJcbiAgICAgICAgcm90YXRpb24gKz0gxpIuS2V5Ym9hcmQubWFwVG9WYWx1ZSgtMSwgMCwgW8aSLktFWUJPQVJEX0NPREUuRV0pO1xyXG5cclxuICAgICAgICBhY3RpdmVTaGFwZS5mb3JtLm1vdmVYKGRpcmVjdGlvbik7XHJcbiAgICAgICAgYWN0aXZlU2hhcGUuZm9ybS5yb3RhdGVaKHJvdGF0aW9uKTtcclxuICAgICAgICB2aWV3cG9ydC5kcmF3KCk7XHJcbiAgICB9XHJcbn1cclxuIl19