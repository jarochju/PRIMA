"use strict";
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
var Tetris;
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
(function (Tetris) {
    var ƒ = FudgeCore;
    window.addEventListener("load", hndLoad);
    let graph;
    let activeShape;
    let colliders = [];
    let lastUpdate = 0;
    let audioCmp;
    let bgMusic;
    let speed;
    let counterUI;
    let level;
    async function hndLoad(_event) {
        const canvas = document.querySelector("canvas");
        counterUI = new Tetris.UIElement("#counter");
        const storage = new Tetris.Storage("./data.json");
        await storage.loadData();
        const { gameInterval } = storage.getData();
        speed = gameInterval;
        // setze Werte der Benutzeroberfläche
        counterUI.setValue(0);
        /*
        counterUI.element.addEventListener("change", ((e: CustomEvent) => {
            console.log(e.detail);
        }) as EventListener);
        */
        // erstelle Level
        createNewLevel();
        // erstelle Audio
        bgMusic = new ƒ.Audio("sounds/tetrisMusic.mp3");
        audioCmp = new ƒ.ComponentAudio(bgMusic, true, false);
        audioCmp.connect(true);
        audioCmp.volume = 0.8;
        // erstelle Kamera
        const cmpCamera = new ƒ.ComponentCamera();
        cmpCamera.mtxPivot.translateZ(25);
        cmpCamera.mtxPivot.rotateY(180);
        // erstelle Viewport und initialisiere Szene
        Tetris.viewport = new ƒ.Viewport();
        Tetris.viewport.initialize("Viewport", graph, cmpCamera, canvas);
        // STARTE SPIEL
        // erstelle erste aktive Form
        setActiveShape();
        // setze input event listener
        document.addEventListener("keypress", control);
        // starte game loop
        console.log("START GAME");
        ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
        ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
    }
    function createNewLevel() {
        ƒ.Loop.stop();
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node("Graph");
        // Lösche alle Kindknoten des Graphs
        graph.removeAllChildren();
        // Wenn kein Level gesetzt wurde erstelle Wände und Boden
        if (!level) {
            level = {
                floor: Tetris.Shape.floor(15, new ƒ.Vector3(-6, -11, 0)),
                leftWall: Tetris.Shape.wall(23, new ƒ.Vector3(-8, -10, 0)),
                rightWall: Tetris.Shape.wall(23, new ƒ.Vector3(8, -10, 0)),
                round: 0
            };
        }
        else {
            level.round += 1;
            counterUI.setValue(level.round);
        }
        graph.appendChild(level.floor);
        graph.appendChild(level.leftWall);
        graph.appendChild(level.rightWall);
        // leere Collider und füge Level-Collider hinzu
        colliders = [];
        colliders.push(level.floor);
        colliders.push(level.leftWall);
        colliders.push(level.rightWall);
    }
    function setActiveShape(shape) {
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node("Graph");
        // setze neue aktive Form
        activeShape = {
            form: shape || Tetris.Shape.random(),
            iteration: 0
        };
        // füge Form zum Szenengraph hinzu
        graph.appendChild(activeShape.form);
    }
    function update(_event) {
        // ermittle zeitlich Differenz zum letzten Update
        const delta = Date.now() - lastUpdate;
        // teste of genug Zeit vergangen ist um das nächste Update zu starten
        // 600 = 600ms
        if (delta > speed) {
            lastUpdate = Date.now();
            // Versuche Form nach unten zu bewegen
            if (!activeShape.form.tryMoveY(colliders)) {
                // Wenn Form mit einem Collider kollidiert
                // Prüfe ob dies bereits beim ersten Durchlauf passierte. Wenn ja ist das Spiel zu Ende,
                // das Level ist bis oben hin gefüllt
                if (activeShape.iteration <= 0) {
                    console.log("GAME OVER");
                    // Erstelle neues leeres Level
                    createNewLevel();
                    // setze neue Form
                    setActiveShape();
                    // starte spiel neu
                    console.log("RESTART GAME");
                    ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
                    ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
                    return;
                }
                // wenn nirgends angestoßen füge Form zu den anderen Collidern hinzu
                colliders.push(activeShape.form);
                // erstelle neue Form
                setActiveShape();
                Tetris.viewport.setBranch(graph);
            }
            else {
                activeShape.iteration += 1;
            }
        }
        Tetris.viewport.draw();
    }
    function control(_event) {
        let direction;
        let rotation;
        // Temporärer Einstieg der Musik. Browser benötigt Nutzerinteraktion bevor er Musik starten kann
        if (!audioCmp.isPlaying)
            audioCmp.play(true);
        direction = ƒ.Keyboard.mapToValue(ƒ.Vector3.X(), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.D
        ]);
        direction.add(ƒ.Keyboard.mapToValue(ƒ.Vector3.X(-1), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.A
        ]));
        rotation = ƒ.Keyboard.mapToValue(1, 0, [ƒ.KEYBOARD_CODE.Q]);
        rotation += ƒ.Keyboard.mapToValue(-1, 0, [ƒ.KEYBOARD_CODE.E]);
        activeShape.form.moveX(direction);
        activeShape.form.rotateZ(rotation);
        Tetris.viewport.draw();
    }
})(Tetris || (Tetris = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXRyaXMvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxJQUFVLE1BQU0sQ0FpTWY7QUFwTUQsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxXQUFVLE1BQU07SUFDWixJQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7SUFlckIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUV6QyxJQUFJLEtBQWEsQ0FBQztJQUNsQixJQUFJLFdBQXdCLENBQUM7SUFDN0IsSUFBSSxTQUFTLEdBQVksRUFBRSxDQUFDO0lBQzVCLElBQUksVUFBVSxHQUFXLENBQUMsQ0FBQztJQUUzQixJQUFJLFFBQTBCLENBQUM7SUFDL0IsSUFBSSxPQUFnQixDQUFDO0lBQ3JCLElBQUksS0FBYSxDQUFDO0lBRWxCLElBQUksU0FBNEIsQ0FBQztJQUVqQyxJQUFJLEtBQVksQ0FBQztJQUNqQixLQUFLLFVBQVUsT0FBTyxDQUFDLE1BQWE7UUFDaEMsTUFBTSxNQUFNLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkUsU0FBUyxHQUFHLElBQUksT0FBQSxTQUFTLENBQVMsVUFBVSxDQUFDLENBQUM7UUFFOUMsTUFBTSxPQUFPLEdBQVksSUFBSSxPQUFBLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNwRCxNQUFNLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QixNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzNDLEtBQUssR0FBRyxZQUFZLENBQUM7UUFFckIscUNBQXFDO1FBQ3JDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEI7Ozs7VUFJRTtRQUVGLGlCQUFpQjtRQUNqQixjQUFjLEVBQUUsQ0FBQztRQUVqQixpQkFBaUI7UUFDakIsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQ2hELFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RCxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZCLFFBQVEsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDO1FBRXRCLGtCQUFrQjtRQUNsQixNQUFNLFNBQVMsR0FBc0IsSUFBSSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDN0QsU0FBUyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFaEMsNENBQTRDO1FBQzVDLE9BQUEsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLE9BQUEsUUFBUSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUUxRCxlQUFlO1FBQ2YsNkJBQTZCO1FBQzdCLGNBQWMsRUFBRSxDQUFDO1FBRWpCLDZCQUE2QjtRQUM3QixRQUFRLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRS9DLG1CQUFtQjtRQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLCtCQUFxQixNQUFNLENBQUMsQ0FBQztRQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxTQUFTLGNBQWM7UUFDbkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVkLGlEQUFpRDtRQUNqRCxJQUFJLENBQUMsS0FBSztZQUFFLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFeEMsb0NBQW9DO1FBQ3BDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRTFCLHlEQUF5RDtRQUN6RCxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1IsS0FBSyxHQUFHO2dCQUNKLEtBQUssRUFBRSxPQUFBLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDakQsUUFBUSxFQUFFLE9BQUEsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCxTQUFTLEVBQUUsT0FBQSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCxLQUFLLEVBQUUsQ0FBQzthQUNYLENBQUM7U0FDTDthQUFNO1lBQ0gsS0FBSyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUM7WUFDakIsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDbkM7UUFFRCxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQixLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsQyxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVuQywrQ0FBK0M7UUFDL0MsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNmLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVCLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxTQUFTLGNBQWMsQ0FBQyxLQUFhO1FBQ2pDLGlEQUFpRDtRQUNqRCxJQUFJLENBQUMsS0FBSztZQUFFLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFeEMseUJBQXlCO1FBQ3pCLFdBQVcsR0FBRztZQUNWLElBQUksRUFBRSxLQUFLLElBQUksT0FBQSxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQzdCLFNBQVMsRUFBRSxDQUFDO1NBQ2YsQ0FBQztRQUVGLGtDQUFrQztRQUNsQyxLQUFLLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsU0FBUyxNQUFNLENBQUMsTUFBZ0I7UUFDNUIsaURBQWlEO1FBQ2pELE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxVQUFVLENBQUM7UUFFOUMscUVBQXFFO1FBQ3JFLGNBQWM7UUFDZCxJQUFJLEtBQUssR0FBRyxLQUFLLEVBQUU7WUFDZixVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBRXhCLHNDQUFzQztZQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ3ZDLDBDQUEwQztnQkFDMUMsd0ZBQXdGO2dCQUN4RixxQ0FBcUM7Z0JBQ3JDLElBQUksV0FBVyxDQUFDLFNBQVMsSUFBSSxDQUFDLEVBQUU7b0JBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBRXpCLDhCQUE4QjtvQkFDOUIsY0FBYyxFQUFFLENBQUM7b0JBRWpCLGtCQUFrQjtvQkFDbEIsY0FBYyxFQUFFLENBQUM7b0JBRWpCLG1CQUFtQjtvQkFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsK0JBQXFCLE1BQU0sQ0FBQyxDQUFDO29CQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUVwQyxPQUFPO2lCQUNWO2dCQUVELG9FQUFvRTtnQkFDcEUsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBRWpDLHFCQUFxQjtnQkFDckIsY0FBYyxFQUFFLENBQUM7Z0JBQ2pCLE9BQUEsUUFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUM3QjtpQkFBTTtnQkFDSCxXQUFXLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQzthQUM5QjtTQUNKO1FBRUQsT0FBQSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELFNBQVMsT0FBTyxDQUFDLE1BQWE7UUFDMUIsSUFBSSxTQUFvQixDQUFDO1FBQ3pCLElBQUksUUFBZ0IsQ0FBQztRQUVyQixnR0FBZ0c7UUFDaEcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTO1lBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QyxTQUFTLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQy9ELENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNwQixDQUFDLENBQUM7UUFDSCxTQUFTLENBQUMsR0FBRyxDQUNULENBQUMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNyRCxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDcEIsQ0FBQyxDQUNMLENBQUM7UUFFRixRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1RCxRQUFRLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTlELFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2xDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25DLE9BQUEsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3BCLENBQUM7QUFDTCxDQUFDLEVBak1TLE1BQU0sS0FBTixNQUFNLFFBaU1mIiwic291cmNlc0NvbnRlbnQiOlsiLy8vPHJlZmVyZW5jZSB0eXBlcz1cIi4uLy4uL0ZVREdFL0NvcmUvRnVkZ2VDb3JlXCIvPlxyXG4vLy88cmVmZXJlbmNlIHR5cGVzPVwiLi4vLi4vRlVER0UvVXNlckludGVyZmFjZS9GdWRnZVVzZXJJbnRlcmZhY2VcIi8+XHJcblxyXG5uYW1lc3BhY2UgVGV0cmlzIHtcclxuICAgIGltcG9ydCDGkiA9IEZ1ZGdlQ29yZTtcclxuICAgIC8vIGltcG9ydCDGklVJID0gRnVkZ2VVc2VySW50ZXJmYWNlO1xyXG5cclxuICAgIGludGVyZmFjZSBBY3RpdmVTaGFwZSB7XHJcbiAgICAgICAgZm9ybTogU2hhcGU7XHJcbiAgICAgICAgaXRlcmF0aW9uOiBudW1iZXI7XHJcbiAgICB9XHJcblxyXG4gICAgaW50ZXJmYWNlIExldmVsIHtcclxuICAgICAgICBmbG9vcjogU2hhcGU7XHJcbiAgICAgICAgbGVmdFdhbGw6IFNoYXBlO1xyXG4gICAgICAgIHJpZ2h0V2FsbDogU2hhcGU7XHJcbiAgICAgICAgcm91bmQ6IG51bWJlcjtcclxuICAgIH1cclxuXHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgaG5kTG9hZCk7XHJcbiAgICBleHBvcnQgbGV0IHZpZXdwb3J0OiDGki5WaWV3cG9ydDtcclxuICAgIGxldCBncmFwaDogxpIuTm9kZTtcclxuICAgIGxldCBhY3RpdmVTaGFwZTogQWN0aXZlU2hhcGU7XHJcbiAgICBsZXQgY29sbGlkZXJzOiBTaGFwZVtdID0gW107XHJcbiAgICBsZXQgbGFzdFVwZGF0ZTogbnVtYmVyID0gMDtcclxuXHJcbiAgICBsZXQgYXVkaW9DbXA6IMaSLkNvbXBvbmVudEF1ZGlvO1xyXG4gICAgbGV0IGJnTXVzaWM6IMaSLkF1ZGlvO1xyXG4gICAgbGV0IHNwZWVkOiBudW1iZXI7XHJcblxyXG4gICAgbGV0IGNvdW50ZXJVSTogVUlFbGVtZW50PG51bWJlcj47XHJcblxyXG4gICAgbGV0IGxldmVsOiBMZXZlbDtcclxuICAgIGFzeW5jIGZ1bmN0aW9uIGhuZExvYWQoX2V2ZW50OiBFdmVudCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiY2FudmFzXCIpO1xyXG4gICAgICAgIGNvdW50ZXJVSSA9IG5ldyBVSUVsZW1lbnQ8bnVtYmVyPihcIiNjb3VudGVyXCIpO1xyXG5cclxuICAgICAgICBjb25zdCBzdG9yYWdlOiBTdG9yYWdlID0gbmV3IFN0b3JhZ2UoXCIuL2RhdGEuanNvblwiKTtcclxuICAgICAgICBhd2FpdCBzdG9yYWdlLmxvYWREYXRhKCk7XHJcbiAgICAgICAgY29uc3QgeyBnYW1lSW50ZXJ2YWwgfSA9IHN0b3JhZ2UuZ2V0RGF0YSgpO1xyXG4gICAgICAgIHNwZWVkID0gZ2FtZUludGVydmFsO1xyXG5cclxuICAgICAgICAvLyBzZXR6ZSBXZXJ0ZSBkZXIgQmVudXR6ZXJvYmVyZmzDpGNoZVxyXG4gICAgICAgIGNvdW50ZXJVSS5zZXRWYWx1ZSgwKTtcclxuICAgICAgICAvKlxyXG4gICAgICAgIGNvdW50ZXJVSS5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgKChlOiBDdXN0b21FdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlLmRldGFpbCk7XHJcbiAgICAgICAgfSkgYXMgRXZlbnRMaXN0ZW5lcik7XHJcbiAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgTGV2ZWxcclxuICAgICAgICBjcmVhdGVOZXdMZXZlbCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBBdWRpb1xyXG4gICAgICAgIGJnTXVzaWMgPSBuZXcgxpIuQXVkaW8oXCJzb3VuZHMvdGV0cmlzTXVzaWMubXAzXCIpO1xyXG4gICAgICAgIGF1ZGlvQ21wID0gbmV3IMaSLkNvbXBvbmVudEF1ZGlvKGJnTXVzaWMsIHRydWUsIGZhbHNlKTtcclxuICAgICAgICBhdWRpb0NtcC5jb25uZWN0KHRydWUpO1xyXG4gICAgICAgIGF1ZGlvQ21wLnZvbHVtZSA9IDAuODtcclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgS2FtZXJhXHJcbiAgICAgICAgY29uc3QgY21wQ2FtZXJhOiDGki5Db21wb25lbnRDYW1lcmEgPSBuZXcgxpIuQ29tcG9uZW50Q2FtZXJhKCk7XHJcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnRyYW5zbGF0ZVooMjUpO1xyXG4gICAgICAgIGNtcENhbWVyYS5tdHhQaXZvdC5yb3RhdGVZKDE4MCk7XHJcblxyXG4gICAgICAgIC8vIGVyc3RlbGxlIFZpZXdwb3J0IHVuZCBpbml0aWFsaXNpZXJlIFN6ZW5lXHJcbiAgICAgICAgdmlld3BvcnQgPSBuZXcgxpIuVmlld3BvcnQoKTtcclxuICAgICAgICB2aWV3cG9ydC5pbml0aWFsaXplKFwiVmlld3BvcnRcIiwgZ3JhcGgsIGNtcENhbWVyYSwgY2FudmFzKTtcclxuXHJcbiAgICAgICAgLy8gU1RBUlRFIFNQSUVMXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgZXJzdGUgYWt0aXZlIEZvcm1cclxuICAgICAgICBzZXRBY3RpdmVTaGFwZSgpO1xyXG5cclxuICAgICAgICAvLyBzZXR6ZSBpbnB1dCBldmVudCBsaXN0ZW5lclxyXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJrZXlwcmVzc1wiLCBjb250cm9sKTtcclxuXHJcbiAgICAgICAgLy8gc3RhcnRlIGdhbWUgbG9vcFxyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiU1RBUlQgR0FNRVwiKTtcclxuICAgICAgICDGki5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoxpIuRVZFTlQuTE9PUF9GUkFNRSwgdXBkYXRlKTtcclxuICAgICAgICDGki5Mb29wLnN0YXJ0KMaSLkxPT1BfTU9ERS5USU1FX1JFQUwpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZU5ld0xldmVsKCk6IHZvaWQge1xyXG4gICAgICAgIMaSLkxvb3Auc3RvcCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBTemVuZW5ncmFwaCAoV3VyemVsa25vdGVuKSB3ZW5uIG7DtnRpZ1xyXG4gICAgICAgIGlmICghZ3JhcGgpIGdyYXBoID0gbmV3IMaSLk5vZGUoXCJHcmFwaFwiKTtcclxuXHJcbiAgICAgICAgLy8gTMO2c2NoZSBhbGxlIEtpbmRrbm90ZW4gZGVzIEdyYXBoc1xyXG4gICAgICAgIGdyYXBoLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcblxyXG4gICAgICAgIC8vIFdlbm4ga2VpbiBMZXZlbCBnZXNldHp0IHd1cmRlIGVyc3RlbGxlIFfDpG5kZSB1bmQgQm9kZW5cclxuICAgICAgICBpZiAoIWxldmVsKSB7XHJcbiAgICAgICAgICAgIGxldmVsID0ge1xyXG4gICAgICAgICAgICAgICAgZmxvb3I6IFNoYXBlLmZsb29yKDE1LCBuZXcgxpIuVmVjdG9yMygtNiwgLTExLCAwKSksXHJcbiAgICAgICAgICAgICAgICBsZWZ0V2FsbDogU2hhcGUud2FsbCgyMywgbmV3IMaSLlZlY3RvcjMoLTgsIC0xMCwgMCkpLFxyXG4gICAgICAgICAgICAgICAgcmlnaHRXYWxsOiBTaGFwZS53YWxsKDIzLCBuZXcgxpIuVmVjdG9yMyg4LCAtMTAsIDApKSxcclxuICAgICAgICAgICAgICAgIHJvdW5kOiAwXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV2ZWwucm91bmQgKz0gMTtcclxuICAgICAgICAgICAgY291bnRlclVJLnNldFZhbHVlKGxldmVsLnJvdW5kKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGdyYXBoLmFwcGVuZENoaWxkKGxldmVsLmZsb29yKTtcclxuICAgICAgICBncmFwaC5hcHBlbmRDaGlsZChsZXZlbC5sZWZ0V2FsbCk7XHJcbiAgICAgICAgZ3JhcGguYXBwZW5kQ2hpbGQobGV2ZWwucmlnaHRXYWxsKTtcclxuXHJcbiAgICAgICAgLy8gbGVlcmUgQ29sbGlkZXIgdW5kIGbDvGdlIExldmVsLUNvbGxpZGVyIGhpbnp1XHJcbiAgICAgICAgY29sbGlkZXJzID0gW107XHJcbiAgICAgICAgY29sbGlkZXJzLnB1c2gobGV2ZWwuZmxvb3IpO1xyXG4gICAgICAgIGNvbGxpZGVycy5wdXNoKGxldmVsLmxlZnRXYWxsKTtcclxuICAgICAgICBjb2xsaWRlcnMucHVzaChsZXZlbC5yaWdodFdhbGwpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNldEFjdGl2ZVNoYXBlKHNoYXBlPzogU2hhcGUpOiB2b2lkIHtcclxuICAgICAgICAvLyBlcnN0ZWxsZSBTemVuZW5ncmFwaCAoV3VyemVsa25vdGVuKSB3ZW5uIG7DtnRpZ1xyXG4gICAgICAgIGlmICghZ3JhcGgpIGdyYXBoID0gbmV3IMaSLk5vZGUoXCJHcmFwaFwiKTtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgbmV1ZSBha3RpdmUgRm9ybVxyXG4gICAgICAgIGFjdGl2ZVNoYXBlID0ge1xyXG4gICAgICAgICAgICBmb3JtOiBzaGFwZSB8fCBTaGFwZS5yYW5kb20oKSxcclxuICAgICAgICAgICAgaXRlcmF0aW9uOiAwXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gZsO8Z2UgRm9ybSB6dW0gU3plbmVuZ3JhcGggaGluenVcclxuICAgICAgICBncmFwaC5hcHBlbmRDaGlsZChhY3RpdmVTaGFwZS5mb3JtKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGUoX2V2ZW50OiDGki5FdmVudMaSKTogdm9pZCB7XHJcbiAgICAgICAgLy8gZXJtaXR0bGUgemVpdGxpY2ggRGlmZmVyZW56IHp1bSBsZXR6dGVuIFVwZGF0ZVxyXG4gICAgICAgIGNvbnN0IGRlbHRhOiBudW1iZXIgPSBEYXRlLm5vdygpIC0gbGFzdFVwZGF0ZTtcclxuXHJcbiAgICAgICAgLy8gdGVzdGUgb2YgZ2VudWcgWmVpdCB2ZXJnYW5nZW4gaXN0IHVtIGRhcyBuw6RjaHN0ZSBVcGRhdGUgenUgc3RhcnRlblxyXG4gICAgICAgIC8vIDYwMCA9IDYwMG1zXHJcbiAgICAgICAgaWYgKGRlbHRhID4gc3BlZWQpIHtcclxuICAgICAgICAgICAgbGFzdFVwZGF0ZSA9IERhdGUubm93KCk7XHJcblxyXG4gICAgICAgICAgICAvLyBWZXJzdWNoZSBGb3JtIG5hY2ggdW50ZW4genUgYmV3ZWdlblxyXG4gICAgICAgICAgICBpZiAoIWFjdGl2ZVNoYXBlLmZvcm0udHJ5TW92ZVkoY29sbGlkZXJzKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gV2VubiBGb3JtIG1pdCBlaW5lbSBDb2xsaWRlciBrb2xsaWRpZXJ0XHJcbiAgICAgICAgICAgICAgICAvLyBQcsO8ZmUgb2IgZGllcyBiZXJlaXRzIGJlaW0gZXJzdGVuIER1cmNobGF1ZiBwYXNzaWVydGUuIFdlbm4gamEgaXN0IGRhcyBTcGllbCB6dSBFbmRlLFxyXG4gICAgICAgICAgICAgICAgLy8gZGFzIExldmVsIGlzdCBiaXMgb2JlbiBoaW4gZ2Vmw7xsbHRcclxuICAgICAgICAgICAgICAgIGlmIChhY3RpdmVTaGFwZS5pdGVyYXRpb24gPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiR0FNRSBPVkVSXCIpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBFcnN0ZWxsZSBuZXVlcyBsZWVyZXMgTGV2ZWxcclxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVOZXdMZXZlbCgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzZXR6ZSBuZXVlIEZvcm1cclxuICAgICAgICAgICAgICAgICAgICBzZXRBY3RpdmVTaGFwZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzdGFydGUgc3BpZWwgbmV1XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJSRVNUQVJUIEdBTUVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgxpIuTG9vcC5hZGRFdmVudExpc3RlbmVyKMaSLkVWRU5ULkxPT1BfRlJBTUUsIHVwZGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgxpIuTG9vcC5zdGFydCjGki5MT09QX01PREUuVElNRV9SRUFMKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIHdlbm4gbmlyZ2VuZHMgYW5nZXN0b8OfZW4gZsO8Z2UgRm9ybSB6dSBkZW4gYW5kZXJlbiBDb2xsaWRlcm4gaGluenVcclxuICAgICAgICAgICAgICAgIGNvbGxpZGVycy5wdXNoKGFjdGl2ZVNoYXBlLmZvcm0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGVyc3RlbGxlIG5ldWUgRm9ybVxyXG4gICAgICAgICAgICAgICAgc2V0QWN0aXZlU2hhcGUoKTtcclxuICAgICAgICAgICAgICAgIHZpZXdwb3J0LnNldEJyYW5jaChncmFwaCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVTaGFwZS5pdGVyYXRpb24gKz0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmlld3BvcnQuZHJhdygpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNvbnRyb2woX2V2ZW50OiBFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGxldCBkaXJlY3Rpb246IMaSLlZlY3RvcjM7XHJcbiAgICAgICAgbGV0IHJvdGF0aW9uOiBudW1iZXI7XHJcblxyXG4gICAgICAgIC8vIFRlbXBvcsOkcmVyIEVpbnN0aWVnIGRlciBNdXNpay4gQnJvd3NlciBiZW7DtnRpZ3QgTnV0emVyaW50ZXJha3Rpb24gYmV2b3IgZXIgTXVzaWsgc3RhcnRlbiBrYW5uXHJcbiAgICAgICAgaWYgKCFhdWRpb0NtcC5pc1BsYXlpbmcpIGF1ZGlvQ21wLnBsYXkodHJ1ZSk7XHJcblxyXG4gICAgICAgIGRpcmVjdGlvbiA9IMaSLktleWJvYXJkLm1hcFRvVmFsdWUoxpIuVmVjdG9yMy5YKCksIMaSLlZlY3RvcjMuWkVSTygpLCBbXHJcbiAgICAgICAgICAgIMaSLktFWUJPQVJEX0NPREUuRFxyXG4gICAgICAgIF0pO1xyXG4gICAgICAgIGRpcmVjdGlvbi5hZGQoXHJcbiAgICAgICAgICAgIMaSLktleWJvYXJkLm1hcFRvVmFsdWUoxpIuVmVjdG9yMy5YKC0xKSwgxpIuVmVjdG9yMy5aRVJPKCksIFtcclxuICAgICAgICAgICAgICAgIMaSLktFWUJPQVJEX0NPREUuQVxyXG4gICAgICAgICAgICBdKVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHJvdGF0aW9uID0gxpIuS2V5Ym9hcmQubWFwVG9WYWx1ZSgxLCAwLCBbxpIuS0VZQk9BUkRfQ09ERS5RXSk7XHJcbiAgICAgICAgcm90YXRpb24gKz0gxpIuS2V5Ym9hcmQubWFwVG9WYWx1ZSgtMSwgMCwgW8aSLktFWUJPQVJEX0NPREUuRV0pO1xyXG5cclxuICAgICAgICBhY3RpdmVTaGFwZS5mb3JtLm1vdmVYKGRpcmVjdGlvbik7XHJcbiAgICAgICAgYWN0aXZlU2hhcGUuZm9ybS5yb3RhdGVaKHJvdGF0aW9uKTtcclxuICAgICAgICB2aWV3cG9ydC5kcmF3KCk7XHJcbiAgICB9XHJcbn1cclxuIl19