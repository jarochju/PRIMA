"use strict";
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
var Tetris;
///<reference types="../../FUDGE/Core/FudgeCore"/>
///<reference types="../../FUDGE/UserInterface/FudgeUserInterface"/>
(function (Tetris) {
    var ƒ = FudgeCore;
    let GameState;
    (function (GameState) {
        GameState[GameState["RUNNING"] = 0] = "RUNNING";
        GameState[GameState["PAUSED"] = 1] = "PAUSED";
        GameState[GameState["STOPPED"] = 2] = "STOPPED";
    })(GameState || (GameState = {}));
    window.addEventListener('load', hndLoad);
    let graph;
    let activeShape;
    let colliders = [];
    let lastUpdate = 0;
    let audioCmp;
    let bgMusic;
    let isMuted = false;
    let counterUI;
    let elementCounterUI;
    let rowsCounterUI;
    let gameOverModal;
    let level;
    let gameState = GameState.STOPPED;
    let gameData;
    let gameDifficulty = 'medium';
    let isSpeedModeOn = false;
    async function hndLoad(_event) {
        const canvas = document.querySelector('canvas');
        /** Control DOM Elements */
        const startBtn = document.querySelector('#start-btn');
        const newGameBtn = document.querySelector('#new-game-btn');
        const muteBtn = document.querySelector('#mute-btn');
        gameOverModal = document.querySelector('#game-over-modal');
        const difficultySelect = document.querySelector('#difficulty-select');
        counterUI = new Tetris.UIElement('#counter');
        elementCounterUI = new Tetris.UIElement('#element-counter');
        rowsCounterUI = new Tetris.UIElement('#rows-counter');
        if (newGameBtn)
            newGameBtn.addEventListener('click', handleStartClick);
        if (startBtn)
            startBtn.addEventListener('click', handlePauseClick);
        if (muteBtn)
            muteBtn.addEventListener('click', handleMuteClick);
        if (difficultySelect) {
            difficultySelect.value = 'medium';
            difficultySelect.addEventListener('change', handleDifficultyChange);
        }
        const storage = new Tetris.Storage('./data.json');
        await storage.loadData();
        gameData = storage.getData();
        // setze Werte der Benutzeroberfläche
        counterUI.setValue(0);
        elementCounterUI.setValue(0);
        rowsCounterUI.setValue(0);
        /*
        counterUI.element.addEventListener('change', ((e: CustomEvent) => {
            console.log(e.detail);
        }) as EventListener);
        */
        // erstelle Audio
        bgMusic = new ƒ.Audio('sounds/tetrisMusic.mp3');
        audioCmp = new ƒ.ComponentAudio(bgMusic, true, false);
        audioCmp.connect(true);
        audioCmp.volume = 0.8;
        // Erstelle neues leeres Level
        createNewLevel();
        // erstelle Kamera
        const cmpCamera = new ƒ.ComponentCamera();
        cmpCamera.mtxPivot.translateZ(25);
        cmpCamera.mtxPivot.rotateY(180);
        // erstelle Viewport und initialisiere Szene
        Tetris.viewport = new ƒ.Viewport();
        Tetris.viewport.initialize('Viewport', graph, cmpCamera, canvas);
        Tetris.viewport.draw();
    }
    function handleStartClick() {
        startGame();
    }
    function handlePauseClick(ev) {
        const pauseBtn = ev.target;
        switch (gameState) {
            case GameState.RUNNING: {
                pauseGame();
                pauseBtn.innerText = 'Resume';
                break;
            }
            case GameState.PAUSED: {
                resumeGame();
                pauseBtn.innerText = 'Pause';
                break;
            }
        }
    }
    function handleMuteClick(ev) {
        const muteBtn = ev.target;
        if (isMuted) {
            isMuted = false;
            audioCmp.volume = 1;
            muteBtn.classList.remove('controls__button--start');
            muteBtn.innerText = 'Turn Off';
        }
        else {
            isMuted = true;
            audioCmp.volume = 0;
            muteBtn.classList.add('controls__button--start');
            muteBtn.innerText = 'Turn On';
        }
    }
    function handleDifficultyChange(ev) {
        const value = ev.target.value;
        gameDifficulty = value;
    }
    function showGameOverModal(show) {
        if (gameOverModal) {
            if (show) {
                if (!gameOverModal.classList.contains('modal--visible'))
                    gameOverModal.classList.add('modal--visible');
            }
            else {
                if (gameOverModal.classList.contains('modal--visible'))
                    gameOverModal.classList.remove('modal--visible');
            }
        }
    }
    function startGame() {
        // STARTE SPIEL
        if (!audioCmp.isPlaying)
            audioCmp.play(true);
        elementCounterUI.setValue(0);
        rowsCounterUI.setValue(0);
        showGameOverModal(false);
        // Erstelle neues leeres Level
        createNewLevel();
        // erstelle erste aktive Form
        setActiveShape();
        // setze input event listener
        document.addEventListener('keypress', control);
        // starte game loop
        console.log('START GAME');
        gameState = GameState.RUNNING;
        ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
        ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
    }
    function pauseGame() {
        if (gameState === GameState.RUNNING) {
            if (audioCmp.isPlaying)
                audioCmp.play(false);
            ƒ.Loop.stop();
            document.removeEventListener('keypress', control);
            gameState = GameState.PAUSED;
        }
    }
    function resumeGame() {
        if (gameState === GameState.PAUSED) {
            document.addEventListener('keypress', control);
            if (!audioCmp.isPlaying)
                audioCmp.play(true);
            ƒ.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
            ƒ.Loop.start(ƒ.LOOP_MODE.TIME_REAL);
            gameState = GameState.RUNNING;
        }
    }
    function stopGame() {
        console.log('GAME OVER');
        if (audioCmp.isPlaying)
            audioCmp.play(false);
        ƒ.Loop.stop();
        document.removeEventListener('keypress', control);
        gameState = GameState.STOPPED;
    }
    function createNewLevel() {
        ƒ.Loop.stop();
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node('Graph');
        // Lösche alle Kindknoten des Graphs
        graph.removeAllChildren();
        // Wenn kein Level gesetzt wurde erstelle Wände und Boden
        if (!level) {
            level = {
                floor: Tetris.Shape.floor(15, new ƒ.Vector3(-6, -11, 0)),
                leftWall: Tetris.Shape.wall(23, new ƒ.Vector3(-8, -10, 0)),
                rightWall: Tetris.Shape.wall(23, new ƒ.Vector3(8, -10, 0)),
                round: 0,
            };
        }
        else {
            level.round += 1;
            counterUI.setValue(level.round);
        }
        graph.appendChild(level.floor);
        graph.appendChild(level.leftWall);
        graph.appendChild(level.rightWall);
        // leere Collider und füge Level-Collider hinzu
        colliders = [];
        colliders.push(level.floor);
        colliders.push(level.leftWall);
        colliders.push(level.rightWall);
    }
    function setActiveShape(shape) {
        // erstelle Szenengraph (Wurzelknoten) wenn nötig
        if (!graph)
            graph = new ƒ.Node('Graph');
        // setze neue aktive Form
        activeShape = {
            form: shape || Tetris.Shape.random(),
            iteration: 0,
        };
        elementCounterUI.setValue(elementCounterUI.value + 1);
        // füge Form zum Szenengraph hinzu
        graph.appendChild(activeShape.form);
    }
    function checkLastRow(lastRowY, maxPerRow) {
        const bottomSegments = new Array();
        // Suche alle Formen die keine Levelbegrenzung darstellen
        for (const collider of colliders) {
            if (!collider.isBorder) {
                // wenn ein Segment in der letzten Reihe ist, füge es in ein Array hinzu
                for (const segment of collider.containerNode.getChildren()) {
                    if (segment.mtxWorld.translation.y <= lastRowY) {
                        bottomSegments.push({
                            node: segment,
                            shape: collider,
                        });
                    }
                }
            }
        }
        // prüfe of alle untersten Felder mit Segmenten belegt sind
        if (bottomSegments.length >= maxPerRow) {
            rowsCounterUI.setValue(rowsCounterUI.value + 1);
            // lösche diese Segmente
            for (const segment of bottomSegments) {
                const parent = segment.node.getParent();
                parent.removeChild(segment.node);
                // prüfe of die Form weitere Segmente enthält. Wenn nicht lösche sie
                if (parent.getChildren().length === 0) {
                    const index = colliders.findIndex((c) => c === segment.shape);
                    colliders.splice(index, 1);
                    graph.removeChild(segment.shape);
                }
            }
            // Bewege alle übrig geblieben Formen um eine Einheit nach unten
            for (const collider of colliders) {
                if (!collider.isBorder)
                    collider.moveDown();
            }
        }
    }
    function update(_event) {
        // ermittle zeitlich Differenz zum letzten Update
        const delta = Date.now() - lastUpdate;
        const gameInterval = !isSpeedModeOn
            ? gameData.difficulties[gameDifficulty].gameInterval
            : 10;
        // teste of genug Zeit vergangen ist um das nächste Update zu starten
        // 600 = 600ms
        if (delta > gameInterval) {
            lastUpdate = Date.now();
            // Versuche Form nach unten zu bewegen
            if (!activeShape.form.tryMove(colliders, 'down')) {
                // Wenn Form mit einem Collider kollidiert
                // Prüfe ob dies bereits beim ersten Durchlauf passierte. Wenn ja ist das Spiel zu Ende,
                // das Level ist bis oben hin gefüllt
                if (activeShape.iteration <= 0) {
                    // starte spiel neu
                    // console.log('RESTART GAME');
                    //startGame();
                    stopGame();
                    showGameOverModal(true);
                    return;
                }
                // wenn nirgends angestoßen füge Form zu den anderen Collidern hinzu
                colliders.push(activeShape.form);
                isSpeedModeOn = false;
                // erstelle neue Form
                setActiveShape();
                Tetris.viewport.setBranch(graph);
            }
            else {
                activeShape.iteration += 1;
            }
            // prüfe ob letzte Reihe voll ist
            checkLastRow(-10, 15);
        }
        Tetris.viewport.draw();
    }
    function control(_event) {
        let direction;
        let rotation;
        if (ƒ.Keyboard.isPressedOne([ƒ.KEYBOARD_CODE.S])) {
            if (!isSpeedModeOn) {
                isSpeedModeOn = true;
                console.log('S');
            }
            return;
        }
        direction = ƒ.Keyboard.mapToValue(ƒ.Vector3.X(), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.D,
        ]);
        direction.add(ƒ.Keyboard.mapToValue(ƒ.Vector3.X(-1), ƒ.Vector3.ZERO(), [
            ƒ.KEYBOARD_CODE.A,
        ]));
        rotation = ƒ.Keyboard.mapToValue(1, 0, [ƒ.KEYBOARD_CODE.Q]);
        rotation += ƒ.Keyboard.mapToValue(-1, 0, [ƒ.KEYBOARD_CODE.E]);
        activeShape.form.rotateZ(rotation);
        if (direction.x === 1) {
            if (!activeShape.form.tryMove(colliders, 'right')) {
                activeShape.form.rotateZ(rotation * -1);
            }
        }
        else {
            if (!activeShape.form.tryMove(colliders, 'left')) {
                activeShape.form.rotateZ(rotation * -1);
            }
        }
        Tetris.viewport.draw();
    }
})(Tetris || (Tetris = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXRyaXMvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxJQUFVLE1BQU0sQ0FzWWY7QUF6WUQsa0RBQWtEO0FBQ2xELG9FQUFvRTtBQUVwRSxXQUFVLE1BQU07SUFDWixJQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7SUFlckIsSUFBSyxTQUlKO0lBSkQsV0FBSyxTQUFTO1FBQ1YsK0NBQU8sQ0FBQTtRQUNQLDZDQUFNLENBQUE7UUFDTiwrQ0FBTyxDQUFBO0lBQ1gsQ0FBQyxFQUpJLFNBQVMsS0FBVCxTQUFTLFFBSWI7SUFJRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRXpDLElBQUksS0FBYSxDQUFDO0lBQ2xCLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLFNBQVMsR0FBWSxFQUFFLENBQUM7SUFDNUIsSUFBSSxVQUFVLEdBQVcsQ0FBQyxDQUFDO0lBRTNCLElBQUksUUFBMEIsQ0FBQztJQUMvQixJQUFJLE9BQWdCLENBQUM7SUFDckIsSUFBSSxPQUFPLEdBQVksS0FBSyxDQUFDO0lBRTdCLElBQUksU0FBNEIsQ0FBQztJQUNqQyxJQUFJLGdCQUFtQyxDQUFDO0lBQ3hDLElBQUksYUFBZ0MsQ0FBQztJQUVyQyxJQUFJLGFBQTZCLENBQUM7SUFFbEMsSUFBSSxLQUFZLENBQUM7SUFDakIsSUFBSSxTQUFTLEdBQWMsU0FBUyxDQUFDLE9BQU8sQ0FBQztJQUM3QyxJQUFJLFFBQWMsQ0FBQztJQUNuQixJQUFJLGNBQWMsR0FBbUIsUUFBUSxDQUFDO0lBRTlDLElBQUksYUFBYSxHQUFZLEtBQUssQ0FBQztJQUVuQyxLQUFLLFVBQVUsT0FBTyxDQUFDLE1BQWE7UUFDaEMsTUFBTSxNQUFNLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFF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Q0FBQyxFQUFFO2dCQUM5QyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMzQztTQUNKO1FBQ0QsT0FBQSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDcEIsQ0FBQztBQUNMLENBQUMsRUF0WVMsTUFBTSxLQUFOLE1BQU0sUUFzWWYiLCJzb3VyY2VzQ29udGVudCI6WyIvLy88cmVmZXJlbmNlIHR5cGVzPVwiLi4vLi4vRlVER0UvQ29yZS9GdWRnZUNvcmVcIi8+XHJcbi8vLzxyZWZlcmVuY2UgdHlwZXM9XCIuLi8uLi9GVURHRS9Vc2VySW50ZXJmYWNlL0Z1ZGdlVXNlckludGVyZmFjZVwiLz5cclxuXHJcbm5hbWVzcGFjZSBUZXRyaXMge1xyXG4gICAgaW1wb3J0IMaSID0gRnVkZ2VDb3JlO1xyXG4gICAgLy8gaW1wb3J0IMaSVUkgPSBGdWRnZVVzZXJJbnRlcmZhY2U7XHJcblxyXG4gICAgaW50ZXJmYWNlIEFjdGl2ZVNoYXBlIHtcclxuICAgICAgICBmb3JtOiBTaGFwZTtcclxuICAgICAgICBpdGVyYXRpb246IG51bWJlcjtcclxuICAgIH1cclxuXHJcbiAgICBpbnRlcmZhY2UgTGV2ZWwge1xyXG4gICAgICAgIGZsb29yOiBTaGFwZTtcclxuICAgICAgICBsZWZ0V2FsbDogU2hhcGU7XHJcbiAgICAgICAgcmlnaHRXYWxsOiBTaGFwZTtcclxuICAgICAgICByb3VuZDogbnVtYmVyO1xyXG4gICAgfVxyXG5cclxuICAgIGVudW0gR2FtZVN0YXRlIHtcclxuICAgICAgICBSVU5OSU5HLFxyXG4gICAgICAgIFBBVVNFRCxcclxuICAgICAgICBTVE9QUEVELFxyXG4gICAgfVxyXG5cclxuICAgIHR5cGUgR2FtZURpZmZpY3VsdHkgPSAnZWFzeScgfCAnbWVkaXVtJyB8ICdoYXJkJztcclxuXHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGhuZExvYWQpO1xyXG4gICAgZXhwb3J0IGxldCB2aWV3cG9ydDogxpIuVmlld3BvcnQ7XHJcbiAgICBsZXQgZ3JhcGg6IMaSLk5vZGU7XHJcbiAgICBsZXQgYWN0aXZlU2hhcGU6IEFjdGl2ZVNoYXBlO1xyXG4gICAgbGV0IGNvbGxpZGVyczogU2hhcGVbXSA9IFtdO1xyXG4gICAgbGV0IGxhc3RVcGRhdGU6IG51bWJlciA9IDA7XHJcblxyXG4gICAgbGV0IGF1ZGlvQ21wOiDGki5Db21wb25lbnRBdWRpbztcclxuICAgIGxldCBiZ011c2ljOiDGki5BdWRpbztcclxuICAgIGxldCBpc011dGVkOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgbGV0IGNvdW50ZXJVSTogVUlFbGVtZW50PG51bWJlcj47XHJcbiAgICBsZXQgZWxlbWVudENvdW50ZXJVSTogVUlFbGVtZW50PG51bWJlcj47XHJcbiAgICBsZXQgcm93c0NvdW50ZXJVSTogVUlFbGVtZW50PG51bWJlcj47XHJcblxyXG4gICAgbGV0IGdhbWVPdmVyTW9kYWw6IEhUTUxEaXZFbGVtZW50O1xyXG5cclxuICAgIGxldCBsZXZlbDogTGV2ZWw7XHJcbiAgICBsZXQgZ2FtZVN0YXRlOiBHYW1lU3RhdGUgPSBHYW1lU3RhdGUuU1RPUFBFRDtcclxuICAgIGxldCBnYW1lRGF0YTogRGF0YTtcclxuICAgIGxldCBnYW1lRGlmZmljdWx0eTogR2FtZURpZmZpY3VsdHkgPSAnbWVkaXVtJztcclxuXHJcbiAgICBsZXQgaXNTcGVlZE1vZGVPbjogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIGFzeW5jIGZ1bmN0aW9uIGhuZExvYWQoX2V2ZW50OiBFdmVudCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdjYW52YXMnKTtcclxuXHJcbiAgICAgICAgLyoqIENvbnRyb2wgRE9NIEVsZW1lbnRzICovXHJcbiAgICAgICAgY29uc3Qgc3RhcnRCdG46IEhUTUxCdXR0b25FbGVtZW50ID1cclxuICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3N0YXJ0LWJ0bicpO1xyXG5cclxuICAgICAgICBjb25zdCBuZXdHYW1lQnRuOiBIVE1MQnV0dG9uRWxlbWVudCA9XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNuZXctZ2FtZS1idG4nKTtcclxuXHJcbiAgICAgICAgY29uc3QgbXV0ZUJ0bjogSFRNTEJ1dHRvbkVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjbXV0ZS1idG4nKTtcclxuICAgICAgICBnYW1lT3Zlck1vZGFsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2dhbWUtb3Zlci1tb2RhbCcpO1xyXG5cclxuICAgICAgICBjb25zdCBkaWZmaWN1bHR5U2VsZWN0OiBIVE1MU2VsZWN0RWxlbWVudCA9XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNkaWZmaWN1bHR5LXNlbGVjdCcpO1xyXG5cclxuICAgICAgICBjb3VudGVyVUkgPSBuZXcgVUlFbGVtZW50PG51bWJlcj4oJyNjb3VudGVyJyk7XHJcbiAgICAgICAgZWxlbWVudENvdW50ZXJVSSA9IG5ldyBVSUVsZW1lbnQ8bnVtYmVyPignI2VsZW1lbnQtY291bnRlcicpO1xyXG4gICAgICAgIHJvd3NDb3VudGVyVUkgPSBuZXcgVUlFbGVtZW50PG51bWJlcj4oJyNyb3dzLWNvdW50ZXInKTtcclxuXHJcbiAgICAgICAgaWYgKG5ld0dhbWVCdG4pIG5ld0dhbWVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVTdGFydENsaWNrKTtcclxuICAgICAgICBpZiAoc3RhcnRCdG4pIHN0YXJ0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlUGF1c2VDbGljayk7XHJcbiAgICAgICAgaWYgKG11dGVCdG4pIG11dGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVNdXRlQ2xpY2spO1xyXG4gICAgICAgIGlmIChkaWZmaWN1bHR5U2VsZWN0KSB7XHJcbiAgICAgICAgICAgIGRpZmZpY3VsdHlTZWxlY3QudmFsdWUgPSAnbWVkaXVtJztcclxuICAgICAgICAgICAgZGlmZmljdWx0eVNlbGVjdC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBoYW5kbGVEaWZmaWN1bHR5Q2hhbmdlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2UgPSBuZXcgU3RvcmFnZSgnLi9kYXRhLmpzb24nKTtcclxuICAgICAgICBhd2FpdCBzdG9yYWdlLmxvYWREYXRhKCk7XHJcbiAgICAgICAgZ2FtZURhdGEgPSBzdG9yYWdlLmdldERhdGEoKTtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgV2VydGUgZGVyIEJlbnV0emVyb2JlcmZsw6RjaGVcclxuICAgICAgICBjb3VudGVyVUkuc2V0VmFsdWUoMCk7XHJcbiAgICAgICAgZWxlbWVudENvdW50ZXJVSS5zZXRWYWx1ZSgwKTtcclxuICAgICAgICByb3dzQ291bnRlclVJLnNldFZhbHVlKDApO1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgY291bnRlclVJLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKChlOiBDdXN0b21FdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlLmRldGFpbCk7XHJcbiAgICAgICAgfSkgYXMgRXZlbnRMaXN0ZW5lcik7XHJcbiAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgQXVkaW9cclxuICAgICAgICBiZ011c2ljID0gbmV3IMaSLkF1ZGlvKCdzb3VuZHMvdGV0cmlzTXVzaWMubXAzJyk7XHJcbiAgICAgICAgYXVkaW9DbXAgPSBuZXcgxpIuQ29tcG9uZW50QXVkaW8oYmdNdXNpYywgdHJ1ZSwgZmFsc2UpO1xyXG4gICAgICAgIGF1ZGlvQ21wLmNvbm5lY3QodHJ1ZSk7XHJcbiAgICAgICAgYXVkaW9DbXAudm9sdW1lID0gMC44O1xyXG5cclxuICAgICAgICAvLyBFcnN0ZWxsZSBuZXVlcyBsZWVyZXMgTGV2ZWxcclxuICAgICAgICBjcmVhdGVOZXdMZXZlbCgpO1xyXG5cclxuICAgICAgICAvLyBlcnN0ZWxsZSBLYW1lcmFcclxuICAgICAgICBjb25zdCBjbXBDYW1lcmE6IMaSLkNvbXBvbmVudENhbWVyYSA9IG5ldyDGki5Db21wb25lbnRDYW1lcmEoKTtcclxuICAgICAgICBjbXBDYW1lcmEubXR4UGl2b3QudHJhbnNsYXRlWigyNSk7XHJcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnJvdGF0ZVkoMTgwKTtcclxuXHJcbiAgICAgICAgLy8gZXJzdGVsbGUgVmlld3BvcnQgdW5kIGluaXRpYWxpc2llcmUgU3plbmVcclxuICAgICAgICB2aWV3cG9ydCA9IG5ldyDGki5WaWV3cG9ydCgpO1xyXG4gICAgICAgIHZpZXdwb3J0LmluaXRpYWxpemUoJ1ZpZXdwb3J0JywgZ3JhcGgsIGNtcENhbWVyYSwgY2FudmFzKTtcclxuICAgICAgICB2aWV3cG9ydC5kcmF3KCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlU3RhcnRDbGljaygpIHtcclxuICAgICAgICBzdGFydEdhbWUoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVQYXVzZUNsaWNrKGV2OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgcGF1c2VCdG4gPSBldi50YXJnZXQgYXMgSFRNTEJ1dHRvbkVsZW1lbnQ7XHJcblxyXG4gICAgICAgIHN3aXRjaCAoZ2FtZVN0YXRlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgR2FtZVN0YXRlLlJVTk5JTkc6IHtcclxuICAgICAgICAgICAgICAgIHBhdXNlR2FtZSgpO1xyXG4gICAgICAgICAgICAgICAgcGF1c2VCdG4uaW5uZXJUZXh0ID0gJ1Jlc3VtZSc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY2FzZSBHYW1lU3RhdGUuUEFVU0VEOiB7XHJcbiAgICAgICAgICAgICAgICByZXN1bWVHYW1lKCk7XHJcbiAgICAgICAgICAgICAgICBwYXVzZUJ0bi5pbm5lclRleHQgPSAnUGF1c2UnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlTXV0ZUNsaWNrKGV2OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgbXV0ZUJ0biA9IGV2LnRhcmdldCBhcyBIVE1MQnV0dG9uRWxlbWVudDtcclxuXHJcbiAgICAgICAgaWYgKGlzTXV0ZWQpIHtcclxuICAgICAgICAgICAgaXNNdXRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBhdWRpb0NtcC52b2x1bWUgPSAxO1xyXG4gICAgICAgICAgICBtdXRlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2NvbnRyb2xzX19idXR0b24tLXN0YXJ0Jyk7XHJcbiAgICAgICAgICAgIG11dGVCdG4uaW5uZXJUZXh0ID0gJ1R1cm4gT2ZmJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpc011dGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgYXVkaW9DbXAudm9sdW1lID0gMDtcclxuICAgICAgICAgICAgbXV0ZUJ0bi5jbGFzc0xpc3QuYWRkKCdjb250cm9sc19fYnV0dG9uLS1zdGFydCcpO1xyXG4gICAgICAgICAgICBtdXRlQnRuLmlubmVyVGV4dCA9ICdUdXJuIE9uJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlRGlmZmljdWx0eUNoYW5nZShldjogRXZlbnQpIHtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IChldi50YXJnZXQgYXMgSFRNTFNlbGVjdEVsZW1lbnQpLnZhbHVlIGFzIEdhbWVEaWZmaWN1bHR5O1xyXG4gICAgICAgIGdhbWVEaWZmaWN1bHR5ID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0dhbWVPdmVyTW9kYWwoc2hvdzogYm9vbGVhbikge1xyXG4gICAgICAgIGlmIChnYW1lT3Zlck1vZGFsKSB7XHJcbiAgICAgICAgICAgIGlmIChzaG93KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWdhbWVPdmVyTW9kYWwuY2xhc3NMaXN0LmNvbnRhaW5zKCdtb2RhbC0tdmlzaWJsZScpKVxyXG4gICAgICAgICAgICAgICAgICAgIGdhbWVPdmVyTW9kYWwuY2xhc3NMaXN0LmFkZCgnbW9kYWwtLXZpc2libGUnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChnYW1lT3Zlck1vZGFsLmNsYXNzTGlzdC5jb250YWlucygnbW9kYWwtLXZpc2libGUnKSlcclxuICAgICAgICAgICAgICAgICAgICBnYW1lT3Zlck1vZGFsLmNsYXNzTGlzdC5yZW1vdmUoJ21vZGFsLS12aXNpYmxlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3RhcnRHYW1lKCkge1xyXG4gICAgICAgIC8vIFNUQVJURSBTUElFTFxyXG4gICAgICAgIGlmICghYXVkaW9DbXAuaXNQbGF5aW5nKSBhdWRpb0NtcC5wbGF5KHRydWUpO1xyXG4gICAgICAgIGVsZW1lbnRDb3VudGVyVUkuc2V0VmFsdWUoMCk7XHJcbiAgICAgICAgcm93c0NvdW50ZXJVSS5zZXRWYWx1ZSgwKTtcclxuICAgICAgICBzaG93R2FtZU92ZXJNb2RhbChmYWxzZSk7XHJcblxyXG4gICAgICAgIC8vIEVyc3RlbGxlIG5ldWVzIGxlZXJlcyBMZXZlbFxyXG4gICAgICAgIGNyZWF0ZU5ld0xldmVsKCk7XHJcblxyXG4gICAgICAgIC8vIGVyc3RlbGxlIGVyc3RlIGFrdGl2ZSBGb3JtXHJcbiAgICAgICAgc2V0QWN0aXZlU2hhcGUoKTtcclxuXHJcbiAgICAgICAgLy8gc2V0emUgaW5wdXQgZXZlbnQgbGlzdGVuZXJcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIGNvbnRyb2wpO1xyXG5cclxuICAgICAgICAvLyBzdGFydGUgZ2FtZSBsb29wXHJcbiAgICAgICAgY29uc29sZS5sb2coJ1NUQVJUIEdBTUUnKTtcclxuICAgICAgICBnYW1lU3RhdGUgPSBHYW1lU3RhdGUuUlVOTklORztcclxuICAgICAgICDGki5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoxpIuRVZFTlQuTE9PUF9GUkFNRSwgdXBkYXRlKTtcclxuICAgICAgICDGki5Mb29wLnN0YXJ0KMaSLkxPT1BfTU9ERS5USU1FX1JFQUwpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHBhdXNlR2FtZSgpIHtcclxuICAgICAgICBpZiAoZ2FtZVN0YXRlID09PSBHYW1lU3RhdGUuUlVOTklORykge1xyXG4gICAgICAgICAgICBpZiAoYXVkaW9DbXAuaXNQbGF5aW5nKSBhdWRpb0NtcC5wbGF5KGZhbHNlKTtcclxuICAgICAgICAgICAgxpIuTG9vcC5zdG9wKCk7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywgY29udHJvbCk7XHJcbiAgICAgICAgICAgIGdhbWVTdGF0ZSA9IEdhbWVTdGF0ZS5QQVVTRUQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlc3VtZUdhbWUoKSB7XHJcbiAgICAgICAgaWYgKGdhbWVTdGF0ZSA9PT0gR2FtZVN0YXRlLlBBVVNFRCkge1xyXG4gICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIGNvbnRyb2wpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFhdWRpb0NtcC5pc1BsYXlpbmcpIGF1ZGlvQ21wLnBsYXkodHJ1ZSk7XHJcbiAgICAgICAgICAgIMaSLkxvb3AuYWRkRXZlbnRMaXN0ZW5lcijGki5FVkVOVC5MT09QX0ZSQU1FLCB1cGRhdGUpO1xyXG4gICAgICAgICAgICDGki5Mb29wLnN0YXJ0KMaSLkxPT1BfTU9ERS5USU1FX1JFQUwpO1xyXG4gICAgICAgICAgICBnYW1lU3RhdGUgPSBHYW1lU3RhdGUuUlVOTklORztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3RvcEdhbWUoKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0dBTUUgT1ZFUicpO1xyXG4gICAgICAgIGlmIChhdWRpb0NtcC5pc1BsYXlpbmcpIGF1ZGlvQ21wLnBsYXkoZmFsc2UpO1xyXG4gICAgICAgIMaSLkxvb3Auc3RvcCgpO1xyXG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywgY29udHJvbCk7XHJcbiAgICAgICAgZ2FtZVN0YXRlID0gR2FtZVN0YXRlLlNUT1BQRUQ7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlTmV3TGV2ZWwoKSB7XHJcbiAgICAgICAgxpIuTG9vcC5zdG9wKCk7XHJcblxyXG4gICAgICAgIC8vIGVyc3RlbGxlIFN6ZW5lbmdyYXBoIChXdXJ6ZWxrbm90ZW4pIHdlbm4gbsO2dGlnXHJcbiAgICAgICAgaWYgKCFncmFwaCkgZ3JhcGggPSBuZXcgxpIuTm9kZSgnR3JhcGgnKTtcclxuXHJcbiAgICAgICAgLy8gTMO2c2NoZSBhbGxlIEtpbmRrbm90ZW4gZGVzIEdyYXBoc1xyXG4gICAgICAgIGdyYXBoLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcblxyXG4gICAgICAgIC8vIFdlbm4ga2VpbiBMZXZlbCBnZXNldHp0IHd1cmRlIGVyc3RlbGxlIFfDpG5kZSB1bmQgQm9kZW5cclxuICAgICAgICBpZiAoIWxldmVsKSB7XHJcbiAgICAgICAgICAgIGxldmVsID0ge1xyXG4gICAgICAgICAgICAgICAgZmxvb3I6IFNoYXBlLmZsb29yKDE1LCBuZXcgxpIuVmVjdG9yMygtNiwgLTExLCAwKSksXHJcbiAgICAgICAgICAgICAgICBsZWZ0V2FsbDogU2hhcGUud2FsbCgyMywgbmV3IMaSLlZlY3RvcjMoLTgsIC0xMCwgMCkpLFxyXG4gICAgICAgICAgICAgICAgcmlnaHRXYWxsOiBTaGFwZS53YWxsKDIzLCBuZXcgxpIuVmVjdG9yMyg4LCAtMTAsIDApKSxcclxuICAgICAgICAgICAgICAgIHJvdW5kOiAwLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldmVsLnJvdW5kICs9IDE7XHJcbiAgICAgICAgICAgIGNvdW50ZXJVSS5zZXRWYWx1ZShsZXZlbC5yb3VuZCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBncmFwaC5hcHBlbmRDaGlsZChsZXZlbC5mbG9vcik7XHJcbiAgICAgICAgZ3JhcGguYXBwZW5kQ2hpbGQobGV2ZWwubGVmdFdhbGwpO1xyXG4gICAgICAgIGdyYXBoLmFwcGVuZENoaWxkKGxldmVsLnJpZ2h0V2FsbCk7XHJcblxyXG4gICAgICAgIC8vIGxlZXJlIENvbGxpZGVyIHVuZCBmw7xnZSBMZXZlbC1Db2xsaWRlciBoaW56dVxyXG4gICAgICAgIGNvbGxpZGVycyA9IFtdO1xyXG4gICAgICAgIGNvbGxpZGVycy5wdXNoKGxldmVsLmZsb29yKTtcclxuICAgICAgICBjb2xsaWRlcnMucHVzaChsZXZlbC5sZWZ0V2FsbCk7XHJcbiAgICAgICAgY29sbGlkZXJzLnB1c2gobGV2ZWwucmlnaHRXYWxsKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZXRBY3RpdmVTaGFwZShzaGFwZT86IFNoYXBlKSB7XHJcbiAgICAgICAgLy8gZXJzdGVsbGUgU3plbmVuZ3JhcGggKFd1cnplbGtub3Rlbikgd2VubiBuw7Z0aWdcclxuICAgICAgICBpZiAoIWdyYXBoKSBncmFwaCA9IG5ldyDGki5Ob2RlKCdHcmFwaCcpO1xyXG5cclxuICAgICAgICAvLyBzZXR6ZSBuZXVlIGFrdGl2ZSBGb3JtXHJcbiAgICAgICAgYWN0aXZlU2hhcGUgPSB7XHJcbiAgICAgICAgICAgIGZvcm06IHNoYXBlIHx8IFNoYXBlLnJhbmRvbSgpLFxyXG4gICAgICAgICAgICBpdGVyYXRpb246IDAsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBlbGVtZW50Q291bnRlclVJLnNldFZhbHVlKGVsZW1lbnRDb3VudGVyVUkudmFsdWUgKyAxKTtcclxuXHJcbiAgICAgICAgLy8gZsO8Z2UgRm9ybSB6dW0gU3plbmVuZ3JhcGggaGluenVcclxuICAgICAgICBncmFwaC5hcHBlbmRDaGlsZChhY3RpdmVTaGFwZS5mb3JtKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjaGVja0xhc3RSb3cobGFzdFJvd1k6IG51bWJlciwgbWF4UGVyUm93OiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBib3R0b21TZWdtZW50czogQXJyYXk8eyBub2RlOiDGki5Ob2RlOyBzaGFwZTogU2hhcGUgfT4gPVxyXG4gICAgICAgICAgICBuZXcgQXJyYXk8eyBub2RlOiDGki5Ob2RlOyBzaGFwZTogU2hhcGUgfT4oKTtcclxuXHJcbiAgICAgICAgLy8gU3VjaGUgYWxsZSBGb3JtZW4gZGllIGtlaW5lIExldmVsYmVncmVuenVuZyBkYXJzdGVsbGVuXHJcbiAgICAgICAgZm9yIChjb25zdCBjb2xsaWRlciBvZiBjb2xsaWRlcnMpIHtcclxuICAgICAgICAgICAgaWYgKCFjb2xsaWRlci5pc0JvcmRlcikge1xyXG4gICAgICAgICAgICAgICAgLy8gd2VubiBlaW4gU2VnbWVudCBpbiBkZXIgbGV0enRlbiBSZWloZSBpc3QsIGbDvGdlIGVzIGluIGVpbiBBcnJheSBoaW56dVxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzZWdtZW50IG9mIGNvbGxpZGVyLmNvbnRhaW5lck5vZGUuZ2V0Q2hpbGRyZW4oKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWdtZW50Lm10eFdvcmxkLnRyYW5zbGF0aW9uLnkgPD0gbGFzdFJvd1kpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tU2VnbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBzZWdtZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGU6IGNvbGxpZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHByw7xmZSBvZiBhbGxlIHVudGVyc3RlbiBGZWxkZXIgbWl0IFNlZ21lbnRlbiBiZWxlZ3Qgc2luZFxyXG4gICAgICAgIGlmIChib3R0b21TZWdtZW50cy5sZW5ndGggPj0gbWF4UGVyUm93KSB7XHJcbiAgICAgICAgICAgIHJvd3NDb3VudGVyVUkuc2V0VmFsdWUocm93c0NvdW50ZXJVSS52YWx1ZSArIDEpO1xyXG5cclxuICAgICAgICAgICAgLy8gbMO2c2NoZSBkaWVzZSBTZWdtZW50ZVxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNlZ21lbnQgb2YgYm90dG9tU2VnbWVudHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudDogxpIuTm9kZSA9IHNlZ21lbnQubm9kZS5nZXRQYXJlbnQoKTtcclxuICAgICAgICAgICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChzZWdtZW50Lm5vZGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHByw7xmZSBvZiBkaWUgRm9ybSB3ZWl0ZXJlIFNlZ21lbnRlIGVudGjDpGx0LiBXZW5uIG5pY2h0IGzDtnNjaGUgc2llXHJcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50LmdldENoaWxkcmVuKCkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBjb2xsaWRlcnMuZmluZEluZGV4KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoYykgPT4gYyA9PT0gc2VnbWVudC5zaGFwZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sbGlkZXJzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JhcGgucmVtb3ZlQ2hpbGQoc2VnbWVudC5zaGFwZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEJld2VnZSBhbGxlIMO8YnJpZyBnZWJsaWViZW4gRm9ybWVuIHVtIGVpbmUgRWluaGVpdCBuYWNoIHVudGVuXHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgY29sbGlkZXIgb2YgY29sbGlkZXJzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbGxpZGVyLmlzQm9yZGVyKSBjb2xsaWRlci5tb3ZlRG93bigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZShfZXZlbnQ6IMaSLkV2ZW50xpIpOiB2b2lkIHtcclxuICAgICAgICAvLyBlcm1pdHRsZSB6ZWl0bGljaCBEaWZmZXJlbnogenVtIGxldHp0ZW4gVXBkYXRlXHJcbiAgICAgICAgY29uc3QgZGVsdGEgPSBEYXRlLm5vdygpIC0gbGFzdFVwZGF0ZTtcclxuICAgICAgICBjb25zdCBnYW1lSW50ZXJ2YWwgPSAhaXNTcGVlZE1vZGVPblxyXG4gICAgICAgICAgICA/IGdhbWVEYXRhLmRpZmZpY3VsdGllc1tnYW1lRGlmZmljdWx0eV0uZ2FtZUludGVydmFsXHJcbiAgICAgICAgICAgIDogMTA7XHJcblxyXG4gICAgICAgIC8vIHRlc3RlIG9mIGdlbnVnIFplaXQgdmVyZ2FuZ2VuIGlzdCB1bSBkYXMgbsOkY2hzdGUgVXBkYXRlIHp1IHN0YXJ0ZW5cclxuICAgICAgICAvLyA2MDAgPSA2MDBtc1xyXG4gICAgICAgIGlmIChkZWx0YSA+IGdhbWVJbnRlcnZhbCkge1xyXG4gICAgICAgICAgICBsYXN0VXBkYXRlID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFZlcnN1Y2hlIEZvcm0gbmFjaCB1bnRlbiB6dSBiZXdlZ2VuXHJcbiAgICAgICAgICAgIGlmICghYWN0aXZlU2hhcGUuZm9ybS50cnlNb3ZlKGNvbGxpZGVycywgJ2Rvd24nKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gV2VubiBGb3JtIG1pdCBlaW5lbSBDb2xsaWRlciBrb2xsaWRpZXJ0XHJcbiAgICAgICAgICAgICAgICAvLyBQcsO8ZmUgb2IgZGllcyBiZXJlaXRzIGJlaW0gZXJzdGVuIER1cmNobGF1ZiBwYXNzaWVydGUuIFdlbm4gamEgaXN0IGRhcyBTcGllbCB6dSBFbmRlLFxyXG4gICAgICAgICAgICAgICAgLy8gZGFzIExldmVsIGlzdCBiaXMgb2JlbiBoaW4gZ2Vmw7xsbHRcclxuICAgICAgICAgICAgICAgIGlmIChhY3RpdmVTaGFwZS5pdGVyYXRpb24gPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0ZSBzcGllbCBuZXVcclxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnUkVTVEFSVCBHQU1FJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9zdGFydEdhbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICBzdG9wR2FtZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3dHYW1lT3Zlck1vZGFsKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyB3ZW5uIG5pcmdlbmRzIGFuZ2VzdG/Dn2VuIGbDvGdlIEZvcm0genUgZGVuIGFuZGVyZW4gQ29sbGlkZXJuIGhpbnp1XHJcbiAgICAgICAgICAgICAgICBjb2xsaWRlcnMucHVzaChhY3RpdmVTaGFwZS5mb3JtKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpc1NwZWVkTW9kZU9uID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAvLyBlcnN0ZWxsZSBuZXVlIEZvcm1cclxuICAgICAgICAgICAgICAgIHNldEFjdGl2ZVNoYXBlKCk7XHJcbiAgICAgICAgICAgICAgICB2aWV3cG9ydC5zZXRCcmFuY2goZ3JhcGgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZlU2hhcGUuaXRlcmF0aW9uICs9IDE7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIHByw7xmZSBvYiBsZXR6dGUgUmVpaGUgdm9sbCBpc3RcclxuICAgICAgICAgICAgY2hlY2tMYXN0Um93KC0xMCwgMTUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmlld3BvcnQuZHJhdygpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNvbnRyb2woX2V2ZW50OiBFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGxldCBkaXJlY3Rpb246IMaSLlZlY3RvcjM7XHJcbiAgICAgICAgbGV0IHJvdGF0aW9uOiBudW1iZXI7XHJcblxyXG4gICAgICAgIGlmICjGki5LZXlib2FyZC5pc1ByZXNzZWRPbmUoW8aSLktFWUJPQVJEX0NPREUuU10pKSB7XHJcbiAgICAgICAgICAgIGlmICghaXNTcGVlZE1vZGVPbikge1xyXG4gICAgICAgICAgICAgICAgaXNTcGVlZE1vZGVPbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGRpcmVjdGlvbiA9IMaSLktleWJvYXJkLm1hcFRvVmFsdWUoxpIuVmVjdG9yMy5YKCksIMaSLlZlY3RvcjMuWkVSTygpLCBbXHJcbiAgICAgICAgICAgIMaSLktFWUJPQVJEX0NPREUuRCxcclxuICAgICAgICBdKTtcclxuICAgICAgICBkaXJlY3Rpb24uYWRkKFxyXG4gICAgICAgICAgICDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKMaSLlZlY3RvcjMuWCgtMSksIMaSLlZlY3RvcjMuWkVSTygpLCBbXHJcbiAgICAgICAgICAgICAgICDGki5LRVlCT0FSRF9DT0RFLkEsXHJcbiAgICAgICAgICAgIF0pXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgcm90YXRpb24gPSDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKDEsIDAsIFvGki5LRVlCT0FSRF9DT0RFLlFdKTtcclxuICAgICAgICByb3RhdGlvbiArPSDGki5LZXlib2FyZC5tYXBUb1ZhbHVlKC0xLCAwLCBbxpIuS0VZQk9BUkRfQ09ERS5FXSk7XHJcblxyXG4gICAgICAgIGFjdGl2ZVNoYXBlLmZvcm0ucm90YXRlWihyb3RhdGlvbik7XHJcblxyXG4gICAgICAgIGlmIChkaXJlY3Rpb24ueCA9PT0gMSkge1xyXG4gICAgICAgICAgICBpZiAoIWFjdGl2ZVNoYXBlLmZvcm0udHJ5TW92ZShjb2xsaWRlcnMsICdyaWdodCcpKSB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVTaGFwZS5mb3JtLnJvdGF0ZVoocm90YXRpb24gKiAtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoIWFjdGl2ZVNoYXBlLmZvcm0udHJ5TW92ZShjb2xsaWRlcnMsICdsZWZ0JykpIHtcclxuICAgICAgICAgICAgICAgIGFjdGl2ZVNoYXBlLmZvcm0ucm90YXRlWihyb3RhdGlvbiAqIC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB2aWV3cG9ydC5kcmF3KCk7XHJcbiAgICB9XHJcbn1cclxuIl19