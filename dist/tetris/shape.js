"use strict";
var Tetris;
(function (Tetris) {
    var ƒ = FudgeCore;
    class Shape extends ƒ.Node {
        static staticUnit = 1.05;
        unit = Shape.staticUnit;
        color = ƒ.Color.CSS("WHITE");
        container;
        constructor(startPos = ƒ.Vector3.ZERO()) {
            super("Shape");
            startPos.scale(this.unit);
            this.addComponent(new ƒ.ComponentTransform(ƒ.Matrix4x4.TRANSLATION(startPos)));
            this.container = new ƒ.Node("Shape_Container");
            this.container.addComponent(new ƒ.ComponentTransform(ƒ.Matrix4x4.TRANSLATION(ƒ.Vector3.ZERO())));
            this.appendChild(this.container);
        }
        static random() {
            let r = Math.random();
            let p = 1 / 7;
            let rx = Math.floor(Math.random() * 12) - 6;
            let y = 10;
            const form = new Shape(new ƒ.Vector3(rx, y, 0));
            if (r > p * 6)
                form.createLN();
            else if (r > p * 5)
                form.createLL();
            else if (r > p * 4)
                form.createLR();
            else if (r > p * 3)
                form.createZL();
            else if (r > p * 2)
                form.createZR();
            else if (r > p * 1)
                form.createSQ();
            else if (r > p * 0)
                form.createTT();
            return form;
        }
        static floor(len, pos = ƒ.Vector3.ZERO()) {
            let form = new Shape(pos);
            form.createLine(len, ƒ.Vector3.ZERO());
            return form;
        }
        static wall(len, pos = ƒ.Vector3.ZERO()) {
            let form = new Shape(pos);
            while (len-- > 0)
                form.createQuad(new ƒ.Vector3(0, form.unit * len - form.unit, 0));
            return form;
        }
        get position() {
            return this.mtxWorld.translation;
        }
        /** Versuche Form um einen Schritt nach unten zu bewegen */
        tryMoveY(colliders) {
            // Kalkuliere Translation um eine Einheit nach unten
            const downMtx = this.mtxLocal.copy;
            downMtx.translateY(-this.unit);
            // speichere Rotation des Form-Containers
            const cRotation = this.container.mtxLocal.rotation.z;
            // Iteriere über jedes Segment einer Form und simuliere eine Translaton nach unten (Weltkoordinatensystem)
            for (const segment of this.container.getChildren()) {
                // Erstelle Matrixkopie des Segments
                const segmentMtx = segment.mtxWorld.copy;
                // Prüfe andhand der Container-Rotation in welche Richtung das Segment bewegt werden muss.
                // Führe daraufhin die Translation durch. (Funktioniert da immer in 90 Grad Schritten gedreht wird :D)
                if (cRotation === 90)
                    segmentMtx.translateX(-this.unit);
                else if (cRotation === -90)
                    segmentMtx.translateX(this.unit);
                else if (cRotation === -180 || cRotation === 180)
                    segmentMtx.translateY(this.unit);
                else
                    segmentMtx.translateY(-this.unit);
                // Prüfe ob die transformierten Segmentkopien mit den Collidern kollidieren
                for (const collider of colliders) {
                    for (const other of collider.container.getChildren()) {
                        const otherTrans = other.mtxWorld.translation;
                        if (!segmentMtx.translation.equals(ƒ.Vector3.ZERO()) &&
                            segmentMtx.translation.isInsideSphere(otherTrans, this.unit / 2)) {
                            // tue nichts, Form ist bereits am Boden
                            return false;
                        }
                    }
                }
            }
            // Wird ausgeführt wenn nicht kollidiert. Führe deshalb eine Translation der Form nach unten aus.
            this.cmpTransform.mtxLocal = downMtx;
            return true;
        }
        moveX(dirX) {
            dirX.scale(this.unit);
            this.mtxLocal?.translate(dirX);
        }
        rotateZ(dir) {
            this.container?.mtxLocal?.rotateZ(dir * 90);
        }
        createLine(len, pos = ƒ.Vector3.ZERO()) {
            while (len-- > 0)
                this.createQuad(new ƒ.Vector3(this.unit * len - this.unit + pos.x, 0 + pos.y, 0 + pos.z));
        }
        createLN() {
            this.color = ƒ.Color.CSS("CYAN");
            this.createLine(4, ƒ.Vector3.ZERO());
        }
        createLL() {
            this.color = ƒ.Color.CSS("MAGENTA");
            this.createLine(3);
            this.createQuad(new ƒ.Vector3(-this.unit, this.unit, 0));
        }
        createLR() {
            this.color = ƒ.Color.CSS("YELLOW");
            this.createLine(3);
            this.createQuad(new ƒ.Vector3(this.unit, this.unit, 0));
        }
        createZL() {
            this.color = ƒ.Color.CSS("RED");
            this.createLine(2, new ƒ.Vector3(this.unit, 0, 0));
            this.createLine(2, new ƒ.Vector3(0, 0 + this.unit, 0));
        }
        createZR() {
            this.color = ƒ.Color.CSS("GREEN");
            this.createLine(2);
            this.createLine(2, new ƒ.Vector3(this.unit, 0 + this.unit, 0));
        }
        createSQ() {
            this.color = ƒ.Color.CSS("BLUE");
            this.createLine(2);
            this.createLine(2, new ƒ.Vector3(0, this.unit, 0));
        }
        createTT() {
            this.color = ƒ.Color.CSS("ORANGE");
            this.createLine(3);
            this.createQuad(new ƒ.Vector3(0, 0 + this.unit, 0));
        }
        createQuad(pos) {
            let mesh = new ƒ.MeshQuad();
            let material = new ƒ.Material("Solid" + this.color.getCSS(), ƒ.ShaderUniColor, new ƒ.CoatColored(this.color));
            let segment = new ƒ.Node("Segment");
            let cmpMesh = new ƒ.ComponentMesh(mesh);
            segment.addComponent(cmpMesh);
            let cmpMaterial = new ƒ.ComponentMaterial(material);
            segment.addComponent(cmpMaterial);
            segment.addComponent(new ƒ.ComponentTransform(ƒ.Matrix4x4.TRANSLATION(pos)));
            this.container.appendChild(segment);
        }
    }
    Tetris.Shape = Shape;
})(Tetris || (Tetris = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGV0cmlzL3NoYXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFVLE1BQU0sQ0FvTWY7QUFwTUQsV0FBVSxNQUFNO0lBQ1osSUFBTyxDQUFDLEdBQUcsU0FBUyxDQUFDO0lBRXJCLE1BQWEsS0FBTSxTQUFRLENBQUMsQ0FBQyxJQUFJO1FBQ3RCLE1BQU0sQ0FBQyxVQUFVLEdBQVcsSUFBSSxDQUFDO1FBQ2pDLElBQUksR0FBVyxLQUFLLENBQUMsVUFBVSxDQUFDO1FBRS9CLEtBQUssR0FBWSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0QyxTQUFTLENBQVM7UUFFMUIsWUFBWSxXQUFzQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUM5QyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDZixRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxQixJQUFJLENBQUMsWUFBWSxDQUNiLElBQUksQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQzlELENBQUM7WUFDRixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQy9DLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUN2QixJQUFJLENBQUMsQ0FBQyxrQkFBa0IsQ0FDcEIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUM1QyxDQUNKLENBQUM7WUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNyQyxDQUFDO1FBRU0sTUFBTSxDQUFDLE1BQU07WUFDaEIsSUFBSSxDQUFDLEdBQVcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzlCLElBQUksQ0FBQyxHQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsSUFBSSxFQUFFLEdBQVcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELElBQUksQ0FBQyxHQUFXLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksR0FBVSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztpQkFDMUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7Z0JBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2lCQUMvQixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQy9CLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztpQkFDL0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7Z0JBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2lCQUMvQixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQy9CLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNwQyxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRU0sTUFBTSxDQUFDLEtBQUssQ0FDZixHQUFXLEVBQ1gsTUFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFFakMsSUFBSSxJQUFJLEdBQVUsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFFTSxNQUFNLENBQUMsSUFBSSxDQUNkLEdBQVcsRUFDWCxNQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUVqQyxJQUFJLElBQUksR0FBVSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqQyxPQUFPLEdBQUcsRUFBRSxHQUFHLENBQUM7Z0JBQ1osSUFBSSxDQUFDLFVBQVUsQ0FDWCxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQ25ELENBQUM7WUFDTixPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsSUFBVyxRQUFRO1lBQ2YsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztRQUNyQyxDQUFDO1FBRUQsMkRBQTJEO1FBQ3BELFFBQVEsQ0FBQyxTQUFrQjtZQUM5QixvREFBb0Q7WUFDcEQsTUFBTSxPQUFPLEdBQWdCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2hELE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFL0IseUNBQXlDO1lBQ3pDLE1BQU0sU0FBUyxHQUFXLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFFN0QsMEdBQTBHO1lBQzFHLEtBQUssTUFBTSxPQUFPLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtnQkFDaEQsb0NBQW9DO2dCQUNwQyxNQUFNLFVBQVUsR0FBZ0IsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7Z0JBRXRELDBGQUEwRjtnQkFDMUYsc0dBQXNHO2dCQUN0RyxJQUFJLFNBQVMsS0FBSyxFQUFFO29CQUFFLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQ25ELElBQUksU0FBUyxLQUFLLENBQUMsRUFBRTtvQkFBRSxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztxQkFDeEQsSUFBSSxTQUFTLEtBQUssQ0FBQyxHQUFHLElBQUksU0FBUyxLQUFLLEdBQUc7b0JBQzVDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOztvQkFDaEMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFdkMsMkVBQTJFO2dCQUMzRSxLQUFLLE1BQU0sUUFBUSxJQUFJLFNBQVMsRUFBRTtvQkFDOUIsS0FBSyxNQUFNLEtBQUssSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxFQUFFO3dCQUNsRCxNQUFNLFVBQVUsR0FDWixLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQzt3QkFFL0IsSUFDSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7NEJBQ2hELFVBQVUsQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUNqQyxVQUFVLEVBQ1YsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQ2hCLEVBQ0g7NEJBQ0Usd0NBQXdDOzRCQUN4QyxPQUFPLEtBQUssQ0FBQzt5QkFDaEI7cUJBQ0o7aUJBQ0o7YUFDSjtZQUNELGlHQUFpRztZQUNqRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7WUFDckMsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUVNLEtBQUssQ0FBQyxJQUFlO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25DLENBQUM7UUFFTSxPQUFPLENBQUMsR0FBVztZQUN0QixJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELENBQUM7UUFFTyxVQUFVLENBQ2QsR0FBVyxFQUNYLE1BQWlCLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBRWpDLE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQztnQkFDWixJQUFJLENBQUMsVUFBVSxDQUNYLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FDVCxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEVBQ25DLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxFQUNULENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUNaLENBQ0osQ0FBQztRQUNWLENBQUM7UUFFTyxRQUFRO1lBQ1osSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekMsQ0FBQztRQUVPLFFBQVE7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3RCxDQUFDO1FBRU8sUUFBUTtZQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRU8sUUFBUTtZQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFTyxRQUFRO1lBQ1osSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUVPLFFBQVE7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkQsQ0FBQztRQUVPLFFBQVE7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVPLFVBQVUsQ0FBQyxHQUFjO1lBQzdCLElBQUksSUFBSSxHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3hDLElBQUksUUFBUSxHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FDckMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQzdCLENBQUMsQ0FBQyxjQUFjLEVBQ2hCLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQ2hDLENBQUM7WUFDRixJQUFJLE9BQU8sR0FBVyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUMsSUFBSSxPQUFPLEdBQW9CLElBQUksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6RCxPQUFPLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlCLElBQUksV0FBVyxHQUF3QixJQUFJLENBQUMsQ0FBQyxpQkFBaUIsQ0FDMUQsUUFBUSxDQUNYLENBQUM7WUFDRixPQUFPLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2xDLE9BQU8sQ0FBQyxZQUFZLENBQ2hCLElBQUksQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQ3pELENBQUM7WUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4QyxDQUFDOztJQS9MUSxZQUFLLFFBZ01qQixDQUFBO0FBQ0wsQ0FBQyxFQXBNUyxNQUFNLEtBQU4sTUFBTSxRQW9NZiIsInNvdXJjZXNDb250ZW50IjpbIm5hbWVzcGFjZSBUZXRyaXMge1xuICAgIGltcG9ydCDGkiA9IEZ1ZGdlQ29yZTtcblxuICAgIGV4cG9ydCBjbGFzcyBTaGFwZSBleHRlbmRzIMaSLk5vZGUge1xuICAgICAgICBwdWJsaWMgc3RhdGljIHN0YXRpY1VuaXQ6IG51bWJlciA9IDEuMDU7XG4gICAgICAgIHB1YmxpYyB1bml0OiBudW1iZXIgPSBTaGFwZS5zdGF0aWNVbml0O1xuXG4gICAgICAgIHByaXZhdGUgY29sb3I6IMaSLkNvbG9yID0gxpIuQ29sb3IuQ1NTKFwiV0hJVEVcIik7XG4gICAgICAgIHByaXZhdGUgY29udGFpbmVyOiDGki5Ob2RlO1xuXG4gICAgICAgIGNvbnN0cnVjdG9yKHN0YXJ0UG9zOiDGki5WZWN0b3IzID0gxpIuVmVjdG9yMy5aRVJPKCkpIHtcbiAgICAgICAgICAgIHN1cGVyKFwiU2hhcGVcIik7XG4gICAgICAgICAgICBzdGFydFBvcy5zY2FsZSh0aGlzLnVuaXQpO1xuICAgICAgICAgICAgdGhpcy5hZGRDb21wb25lbnQoXG4gICAgICAgICAgICAgICAgbmV3IMaSLkNvbXBvbmVudFRyYW5zZm9ybSjGki5NYXRyaXg0eDQuVFJBTlNMQVRJT04oc3RhcnRQb3MpKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IMaSLk5vZGUoXCJTaGFwZV9Db250YWluZXJcIik7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDb21wb25lbnQoXG4gICAgICAgICAgICAgICAgbmV3IMaSLkNvbXBvbmVudFRyYW5zZm9ybShcbiAgICAgICAgICAgICAgICAgICAgxpIuTWF0cml4NHg0LlRSQU5TTEFUSU9OKMaSLlZlY3RvcjMuWkVSTygpKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKHRoaXMuY29udGFpbmVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBzdGF0aWMgcmFuZG9tKCk6IFNoYXBlIHtcbiAgICAgICAgICAgIGxldCByOiBudW1iZXIgPSBNYXRoLnJhbmRvbSgpO1xuICAgICAgICAgICAgbGV0IHA6IG51bWJlciA9IDEgLyA3O1xuICAgICAgICAgICAgbGV0IHJ4OiBudW1iZXIgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMikgLSA2O1xuICAgICAgICAgICAgbGV0IHk6IG51bWJlciA9IDEwO1xuICAgICAgICAgICAgY29uc3QgZm9ybTogU2hhcGUgPSBuZXcgU2hhcGUobmV3IMaSLlZlY3RvcjMocngsIHksIDApKTtcbiAgICAgICAgICAgIGlmIChyID4gcCAqIDYpIGZvcm0uY3JlYXRlTE4oKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHIgPiBwICogNSkgZm9ybS5jcmVhdGVMTCgpO1xuICAgICAgICAgICAgZWxzZSBpZiAociA+IHAgKiA0KSBmb3JtLmNyZWF0ZUxSKCk7XG4gICAgICAgICAgICBlbHNlIGlmIChyID4gcCAqIDMpIGZvcm0uY3JlYXRlWkwoKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHIgPiBwICogMikgZm9ybS5jcmVhdGVaUigpO1xuICAgICAgICAgICAgZWxzZSBpZiAociA+IHAgKiAxKSBmb3JtLmNyZWF0ZVNRKCk7XG4gICAgICAgICAgICBlbHNlIGlmIChyID4gcCAqIDApIGZvcm0uY3JlYXRlVFQoKTtcbiAgICAgICAgICAgIHJldHVybiBmb3JtO1xuICAgICAgICB9XG5cbiAgICAgICAgcHVibGljIHN0YXRpYyBmbG9vcihcbiAgICAgICAgICAgIGxlbjogbnVtYmVyLFxuICAgICAgICAgICAgcG9zOiDGki5WZWN0b3IzID0gxpIuVmVjdG9yMy5aRVJPKClcbiAgICAgICAgKTogU2hhcGUge1xuICAgICAgICAgICAgbGV0IGZvcm06IFNoYXBlID0gbmV3IFNoYXBlKHBvcyk7XG4gICAgICAgICAgICBmb3JtLmNyZWF0ZUxpbmUobGVuLCDGki5WZWN0b3IzLlpFUk8oKSk7XG4gICAgICAgICAgICByZXR1cm4gZm9ybTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBzdGF0aWMgd2FsbChcbiAgICAgICAgICAgIGxlbjogbnVtYmVyLFxuICAgICAgICAgICAgcG9zOiDGki5WZWN0b3IzID0gxpIuVmVjdG9yMy5aRVJPKClcbiAgICAgICAgKTogU2hhcGUge1xuICAgICAgICAgICAgbGV0IGZvcm06IFNoYXBlID0gbmV3IFNoYXBlKHBvcyk7XG4gICAgICAgICAgICB3aGlsZSAobGVuLS0gPiAwKVxuICAgICAgICAgICAgICAgIGZvcm0uY3JlYXRlUXVhZChcbiAgICAgICAgICAgICAgICAgICAgbmV3IMaSLlZlY3RvcjMoMCwgZm9ybS51bml0ICogbGVuIC0gZm9ybS51bml0LCAwKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gZm9ybTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBnZXQgcG9zaXRpb24oKTogxpIuVmVjdG9yMyB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tdHhXb3JsZC50cmFuc2xhdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKiBWZXJzdWNoZSBGb3JtIHVtIGVpbmVuIFNjaHJpdHQgbmFjaCB1bnRlbiB6dSBiZXdlZ2VuICovXG4gICAgICAgIHB1YmxpYyB0cnlNb3ZlWShjb2xsaWRlcnM6IFNoYXBlW10pOiBib29sZWFuIHtcbiAgICAgICAgICAgIC8vIEthbGt1bGllcmUgVHJhbnNsYXRpb24gdW0gZWluZSBFaW5oZWl0IG5hY2ggdW50ZW5cbiAgICAgICAgICAgIGNvbnN0IGRvd25NdHg6IMaSLk1hdHJpeDR4NCA9IHRoaXMubXR4TG9jYWwuY29weTtcbiAgICAgICAgICAgIGRvd25NdHgudHJhbnNsYXRlWSgtdGhpcy51bml0KTtcblxuICAgICAgICAgICAgLy8gc3BlaWNoZXJlIFJvdGF0aW9uIGRlcyBGb3JtLUNvbnRhaW5lcnNcbiAgICAgICAgICAgIGNvbnN0IGNSb3RhdGlvbjogbnVtYmVyID0gdGhpcy5jb250YWluZXIubXR4TG9jYWwucm90YXRpb24uejtcblxuICAgICAgICAgICAgLy8gSXRlcmllcmUgw7xiZXIgamVkZXMgU2VnbWVudCBlaW5lciBGb3JtIHVuZCBzaW11bGllcmUgZWluZSBUcmFuc2xhdG9uIG5hY2ggdW50ZW4gKFdlbHRrb29yZGluYXRlbnN5c3RlbSlcbiAgICAgICAgICAgIGZvciAoY29uc3Qgc2VnbWVudCBvZiB0aGlzLmNvbnRhaW5lci5nZXRDaGlsZHJlbigpKSB7XG4gICAgICAgICAgICAgICAgLy8gRXJzdGVsbGUgTWF0cml4a29waWUgZGVzIFNlZ21lbnRzXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VnbWVudE10eDogxpIuTWF0cml4NHg0ID0gc2VnbWVudC5tdHhXb3JsZC5jb3B5O1xuXG4gICAgICAgICAgICAgICAgLy8gUHLDvGZlIGFuZGhhbmQgZGVyIENvbnRhaW5lci1Sb3RhdGlvbiBpbiB3ZWxjaGUgUmljaHR1bmcgZGFzIFNlZ21lbnQgYmV3ZWd0IHdlcmRlbiBtdXNzLlxuICAgICAgICAgICAgICAgIC8vIEbDvGhyZSBkYXJhdWZoaW4gZGllIFRyYW5zbGF0aW9uIGR1cmNoLiAoRnVua3Rpb25pZXJ0IGRhIGltbWVyIGluIDkwIEdyYWQgU2Nocml0dGVuIGdlZHJlaHQgd2lyZCA6RClcbiAgICAgICAgICAgICAgICBpZiAoY1JvdGF0aW9uID09PSA5MCkgc2VnbWVudE10eC50cmFuc2xhdGVYKC10aGlzLnVuaXQpO1xuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNSb3RhdGlvbiA9PT0gLTkwKSBzZWdtZW50TXR4LnRyYW5zbGF0ZVgodGhpcy51bml0KTtcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChjUm90YXRpb24gPT09IC0xODAgfHwgY1JvdGF0aW9uID09PSAxODApXG4gICAgICAgICAgICAgICAgICAgIHNlZ21lbnRNdHgudHJhbnNsYXRlWSh0aGlzLnVuaXQpO1xuICAgICAgICAgICAgICAgIGVsc2Ugc2VnbWVudE10eC50cmFuc2xhdGVZKC10aGlzLnVuaXQpO1xuXG4gICAgICAgICAgICAgICAgLy8gUHLDvGZlIG9iIGRpZSB0cmFuc2Zvcm1pZXJ0ZW4gU2VnbWVudGtvcGllbiBtaXQgZGVuIENvbGxpZGVybiBrb2xsaWRpZXJlblxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgY29sbGlkZXIgb2YgY29sbGlkZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3RoZXIgb2YgY29sbGlkZXIuY29udGFpbmVyLmdldENoaWxkcmVuKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyVHJhbnM6IMaSLlZlY3RvcjMgPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyLm10eFdvcmxkLnRyYW5zbGF0aW9uO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIXNlZ21lbnRNdHgudHJhbnNsYXRpb24uZXF1YWxzKMaSLlZlY3RvcjMuWkVSTygpKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRNdHgudHJhbnNsYXRpb24uaXNJbnNpZGVTcGhlcmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyVHJhbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudW5pdCAvIDJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0dWUgbmljaHRzLCBGb3JtIGlzdCBiZXJlaXRzIGFtIEJvZGVuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gV2lyZCBhdXNnZWbDvGhydCB3ZW5uIG5pY2h0IGtvbGxpZGllcnQuIEbDvGhyZSBkZXNoYWxiIGVpbmUgVHJhbnNsYXRpb24gZGVyIEZvcm0gbmFjaCB1bnRlbiBhdXMuXG4gICAgICAgICAgICB0aGlzLmNtcFRyYW5zZm9ybS5tdHhMb2NhbCA9IGRvd25NdHg7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBtb3ZlWChkaXJYOiDGki5WZWN0b3IzKTogdm9pZCB7XG4gICAgICAgICAgICBkaXJYLnNjYWxlKHRoaXMudW5pdCk7XG4gICAgICAgICAgICB0aGlzLm10eExvY2FsPy50cmFuc2xhdGUoZGlyWCk7XG4gICAgICAgIH1cblxuICAgICAgICBwdWJsaWMgcm90YXRlWihkaXI6IG51bWJlcik6IHZvaWQge1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXI/Lm10eExvY2FsPy5yb3RhdGVaKGRpciAqIDkwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaXZhdGUgY3JlYXRlTGluZShcbiAgICAgICAgICAgIGxlbjogbnVtYmVyLFxuICAgICAgICAgICAgcG9zOiDGki5WZWN0b3IzID0gxpIuVmVjdG9yMy5aRVJPKClcbiAgICAgICAgKTogdm9pZCB7XG4gICAgICAgICAgICB3aGlsZSAobGVuLS0gPiAwKVxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUXVhZChcbiAgICAgICAgICAgICAgICAgICAgbmV3IMaSLlZlY3RvcjMoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVuaXQgKiBsZW4gLSB0aGlzLnVuaXQgKyBwb3MueCxcbiAgICAgICAgICAgICAgICAgICAgICAgIDAgKyBwb3MueSxcbiAgICAgICAgICAgICAgICAgICAgICAgIDAgKyBwb3MuelxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaXZhdGUgY3JlYXRlTE4oKTogdm9pZCB7XG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gxpIuQ29sb3IuQ1NTKFwiQ1lBTlwiKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSg0LCDGki5WZWN0b3IzLlpFUk8oKSk7XG4gICAgICAgIH1cblxuICAgICAgICBwcml2YXRlIGNyZWF0ZUxMKCk6IHZvaWQge1xuICAgICAgICAgICAgdGhpcy5jb2xvciA9IMaSLkNvbG9yLkNTUyhcIk1BR0VOVEFcIik7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoMyk7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVF1YWQobmV3IMaSLlZlY3RvcjMoLXRoaXMudW5pdCwgdGhpcy51bml0LCAwKSk7XG4gICAgICAgIH1cblxuICAgICAgICBwcml2YXRlIGNyZWF0ZUxSKCk6IHZvaWQge1xuICAgICAgICAgICAgdGhpcy5jb2xvciA9IMaSLkNvbG9yLkNTUyhcIllFTExPV1wiKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgzKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlUXVhZChuZXcgxpIuVmVjdG9yMyh0aGlzLnVuaXQsIHRoaXMudW5pdCwgMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJpdmF0ZSBjcmVhdGVaTCgpOiB2b2lkIHtcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSDGki5Db2xvci5DU1MoXCJSRURcIik7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoMiwgbmV3IMaSLlZlY3RvcjModGhpcy51bml0LCAwLCAwKSk7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoMiwgbmV3IMaSLlZlY3RvcjMoMCwgMCArIHRoaXMudW5pdCwgMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJpdmF0ZSBjcmVhdGVaUigpOiB2b2lkIHtcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSDGki5Db2xvci5DU1MoXCJHUkVFTlwiKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgyKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgyLCBuZXcgxpIuVmVjdG9yMyh0aGlzLnVuaXQsIDAgKyB0aGlzLnVuaXQsIDApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaXZhdGUgY3JlYXRlU1EoKTogdm9pZCB7XG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gxpIuQ29sb3IuQ1NTKFwiQkxVRVwiKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgyKTtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgyLCBuZXcgxpIuVmVjdG9yMygwLCB0aGlzLnVuaXQsIDApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaXZhdGUgY3JlYXRlVFQoKTogdm9pZCB7XG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gxpIuQ29sb3IuQ1NTKFwiT1JBTkdFXCIpO1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKDMpO1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVRdWFkKG5ldyDGki5WZWN0b3IzKDAsIDAgKyB0aGlzLnVuaXQsIDApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaXZhdGUgY3JlYXRlUXVhZChwb3M6IMaSLlZlY3RvcjMpOiB2b2lkIHtcbiAgICAgICAgICAgIGxldCBtZXNoOiDGki5NZXNoUXVhZCA9IG5ldyDGki5NZXNoUXVhZCgpO1xuICAgICAgICAgICAgbGV0IG1hdGVyaWFsOiDGki5NYXRlcmlhbCA9IG5ldyDGki5NYXRlcmlhbChcbiAgICAgICAgICAgICAgICBcIlNvbGlkXCIgKyB0aGlzLmNvbG9yLmdldENTUygpLFxuICAgICAgICAgICAgICAgIMaSLlNoYWRlclVuaUNvbG9yLFxuICAgICAgICAgICAgICAgIG5ldyDGki5Db2F0Q29sb3JlZCh0aGlzLmNvbG9yKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGxldCBzZWdtZW50OiDGki5Ob2RlID0gbmV3IMaSLk5vZGUoXCJTZWdtZW50XCIpO1xuICAgICAgICAgICAgbGV0IGNtcE1lc2g6IMaSLkNvbXBvbmVudE1lc2ggPSBuZXcgxpIuQ29tcG9uZW50TWVzaChtZXNoKTtcbiAgICAgICAgICAgIHNlZ21lbnQuYWRkQ29tcG9uZW50KGNtcE1lc2gpO1xuICAgICAgICAgICAgbGV0IGNtcE1hdGVyaWFsOiDGki5Db21wb25lbnRNYXRlcmlhbCA9IG5ldyDGki5Db21wb25lbnRNYXRlcmlhbChcbiAgICAgICAgICAgICAgICBtYXRlcmlhbFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHNlZ21lbnQuYWRkQ29tcG9uZW50KGNtcE1hdGVyaWFsKTtcbiAgICAgICAgICAgIHNlZ21lbnQuYWRkQ29tcG9uZW50KFxuICAgICAgICAgICAgICAgIG5ldyDGki5Db21wb25lbnRUcmFuc2Zvcm0oxpIuTWF0cml4NHg0LlRSQU5TTEFUSU9OKHBvcykpXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQoc2VnbWVudCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=