"use strict";
var Tetris;
(function (Tetris) {
    var ƒ = FudgeCore;
    class Form extends ƒ.Node {
        constructor(startPos = ƒ.Vector3.ZERO()) {
            super("Form");
            this.unit = Form.staticUnit;
            this.dirY = ƒ.Vector3.Y(-this.unit);
            this.color = ƒ.Color.CSS("WHITE");
            startPos.scale(this.unit);
            this.addComponent(new ƒ.ComponentTransform(ƒ.Matrix4x4.TRANSLATION(startPos)));
            this.container = new ƒ.Node("Form_Container");
            this.container.addComponent(new ƒ.ComponentTransform(ƒ.Matrix4x4.TRANSLATION(ƒ.Vector3.ZERO())));
            this.appendChild(this.container);
        }
        static random() {
            let r = Math.random();
            let p = 1 / 7;
            let rx = Math.floor(Math.random() * 12) - 6;
            let y = 10;
            let form = new Form(new ƒ.Vector3(rx, y, 0));
            if (r > p * 6)
                form.createLN();
            else if (r > p * 5)
                form.createLL();
            else if (r > p * 4)
                form.createLR();
            else if (r > p * 3)
                form.createZL();
            else if (r > p * 2)
                form.createZR();
            else if (r > p * 1)
                form.createSQ();
            else if (r > p * 0)
                form.createTT();
            return form;
        }
        static floor(len, pos = ƒ.Vector3.ZERO()) {
            let form = new Form(pos);
            form.createLine(len, ƒ.Vector3.ZERO());
            return form;
        }
        static wall(len, pos = ƒ.Vector3.ZERO()) {
            let form = new Form(pos);
            while (len-- > 0)
                form.createQuad(new ƒ.Vector3(0, form.unit * len - form.unit, 0));
            0;
            return form;
        }
        get position() {
            return this.mtxWorld.translation;
        }
        tryMoveY(colliders) {
            let transform = this.getComponent(ƒ.ComponentTransform);
            let matrix = transform.local.copy;
            let negDir = this.dirY.copy;
            negDir.scale(-1);
            let negTrix = transform.local.copy;
            matrix.translate(this.dirY);
            negTrix.translate(negDir);
            let newTransform = new ƒ.ComponentTransform(matrix);
            let negTransform = new ƒ.ComponentTransform(negTrix);
            this.removeComponent(transform);
            this.addComponent(newTransform);
            for (let child of this.container.getChildren()) {
                for (let collider of colliders) {
                    for (let other of collider.container.getChildren()) {
                        let cp = child.mtxWorld.translation;
                        let op = other.mtxWorld.translation;
                        if (!cp.equals(ƒ.Vector3.ZERO()) && cp.isInsideSphere(op, this.unit / 2)) {
                            this.removeComponent(newTransform);
                            this.addComponent(negTransform);
                            return false;
                        }
                    }
                }
            }
            return true;
        }
        moveX(dirX) {
            dirX.scale(this.unit);
            let transform = this.getComponent(ƒ.ComponentTransform);
            let matrix = transform.local.copy;
            matrix.translate(dirX);
            this.removeComponent(transform);
            this.addComponent(new ƒ.ComponentTransform(matrix));
        }
        rotateZ(dir) {
            let transform = this.container.getComponent(ƒ.ComponentTransform);
            let matrix = transform.local.copy;
            matrix.rotateZ(dir * 90);
            this.container.removeComponent(transform);
            this.container.addComponent(new ƒ.ComponentTransform(matrix));
        }
        createLine(len, pos = ƒ.Vector3.ZERO()) {
            while (len-- > 0)
                this.createQuad(new ƒ.Vector3(this.unit * len - this.unit + pos.x, 0 + pos.y, 0 + pos.z));
        }
        createLN() {
            this.color = ƒ.Color.CSS("CYAN");
            this.createLine(4, ƒ.Vector3.ZERO());
        }
        createLL() {
            this.color = ƒ.Color.CSS("MAGENTA");
            this.createLine(3);
            this.createQuad(new ƒ.Vector3(-this.unit, this.unit, 0));
        }
        createLR() {
            this.color = ƒ.Color.CSS("YELLOW");
            this.createLine(3);
            this.createQuad(new ƒ.Vector3(this.unit, this.unit, 0));
        }
        createZL() {
            this.color = ƒ.Color.CSS("RED");
            this.createLine(2, new ƒ.Vector3(this.unit, 0, 0));
            this.createLine(2, new ƒ.Vector3(0, 0 + this.unit, 0));
        }
        createZR() {
            this.color = ƒ.Color.CSS("GREEN");
            this.createLine(2);
            this.createLine(2, new ƒ.Vector3(this.unit, 0 + this.unit, 0));
        }
        createSQ() {
            this.color = ƒ.Color.CSS("BLUE");
            this.createLine(2);
            this.createLine(2, new ƒ.Vector3(0, this.unit, 0));
        }
        createTT() {
            this.color = ƒ.Color.CSS("ORANGE");
            this.createLine(3);
            this.createQuad(new ƒ.Vector3(0, 0 + this.unit, 0));
        }
        createQuad(pos) {
            let mesh = new ƒ.MeshQuad();
            let material = new ƒ.Material("Solid" + this.color.getCSS(), ƒ.ShaderUniColor, new ƒ.CoatColored(this.color));
            let segment = new ƒ.Node("Segment");
            let cmpMesh = new ƒ.ComponentMesh(mesh);
            segment.addComponent(cmpMesh);
            let cmpMaterial = new ƒ.ComponentMaterial(material);
            segment.addComponent(cmpMaterial);
            segment.addComponent(new ƒ.ComponentTransform(ƒ.Matrix4x4.TRANSLATION(pos)));
            this.container.appendChild(segment);
        }
    }
    Form.staticUnit = 1.05;
    Tetris.Form = Form;
})(Tetris || (Tetris = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRm9ybS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQVUsTUFBTSxDQTJLZjtBQTNLRCxXQUFVLE1BQU07SUFDWixJQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7SUFFckIsTUFBYSxJQUFLLFNBQVEsQ0FBQyxDQUFDLElBQUk7UUFRNUIsWUFBWSxXQUFzQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUM5QyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFQWCxTQUFJLEdBQVcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUU5QixTQUFJLEdBQWMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUMsVUFBSyxHQUFZLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBSzFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9FLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDOUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNyQyxDQUFDO1FBRU0sTUFBTSxDQUFDLE1BQU07WUFDaEIsSUFBSSxDQUFDLEdBQVcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzlCLElBQUksQ0FBQyxHQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsSUFBSSxFQUFFLEdBQVcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELElBQUksQ0FBQyxHQUFXLEVBQUUsQ0FBQztZQUNuQixJQUFJLElBQUksR0FBUyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUNULElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztpQkFDZixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFDZCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQ2YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7Z0JBQ2QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2lCQUNmLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUNkLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztpQkFDZixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFDZCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQ2YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7Z0JBQ2QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2lCQUNmLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUNkLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNwQixPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFXLEVBQUUsTUFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDOUQsSUFBSSxJQUFJLEdBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFFTSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQVcsRUFBRSxNQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtZQUM3RCxJQUFJLElBQUksR0FBUyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMvQixPQUFPLEdBQUcsRUFBRSxHQUFHLENBQUM7Z0JBQ1osSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLENBQUMsQ0FBQTtZQUN4RSxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsSUFBVyxRQUFRO1lBQ2YsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztRQUNyQyxDQUFDO1FBRU0sUUFBUSxDQUFDLFNBQWlCO1lBQzdCLElBQUksU0FBUyxHQUF5QixJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzlFLElBQUksTUFBTSxHQUFnQixTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztZQUUvQyxJQUFJLE1BQU0sR0FBYyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN2QyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakIsSUFBSSxPQUFPLEdBQWdCLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO1lBRWhELE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVCLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFMUIsSUFBSSxZQUFZLEdBQXlCLElBQUksQ0FBQyxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFFLElBQUksWUFBWSxHQUF5QixJQUFJLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUUzRSxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFaEMsS0FBSyxJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxFQUFFO2dCQUM1QyxLQUFLLElBQUksUUFBUSxJQUFJLFNBQVMsRUFBRTtvQkFDNUIsS0FBSyxJQUFJLEtBQUssSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxFQUFFO3dCQUNoRCxJQUFJLEVBQUUsR0FBYyxLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQzt3QkFDL0MsSUFBSSxFQUFFLEdBQWMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7d0JBRS9DLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFOzRCQUN0RSxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDOzRCQUNuQyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDOzRCQUNoQyxPQUFPLEtBQUssQ0FBQzt5QkFDaEI7cUJBQ0o7aUJBQ0o7YUFDSjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFFTSxLQUFLLENBQUMsSUFBZTtZQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QixJQUFJLFNBQVMsR0FBeUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUM5RSxJQUFJLE1BQU0sR0FBZ0IsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7WUFDL0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN2QixJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN4RCxDQUFDO1FBRU0sT0FBTyxDQUFDLEdBQVc7WUFDdEIsSUFBSSxTQUFTLEdBQXlCLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ3hGLElBQUksTUFBTSxHQUFnQixTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztZQUMvQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFFTyxVQUFVLENBQUMsR0FBVyxFQUFFLE1BQWlCLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQzdELE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQztnQkFDWixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xHLENBQUM7UUFFTyxRQUFRO1lBQ1osSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekMsQ0FBQztRQUVPLFFBQVE7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3RCxDQUFDO1FBRU8sUUFBUTtZQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRU8sUUFBUTtZQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFTyxRQUFRO1lBQ1osSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUVPLFFBQVE7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkQsQ0FBQztRQUVPLFFBQVE7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVPLFVBQVUsQ0FBQyxHQUFjO1lBQzdCLElBQUksSUFBSSxHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3hDLElBQUksUUFBUSxHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUMxSCxJQUFJLE9BQU8sR0FBVyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUMsSUFBSSxPQUFPLEdBQW9CLElBQUksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6RCxPQUFPLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlCLElBQUksV0FBVyxHQUF3QixJQUFJLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN6RSxPQUFPLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2xDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLENBQUM7O0lBbkthLGVBQVUsR0FBVyxJQUFJLENBQUM7SUFEL0IsV0FBSSxPQXNLaEIsQ0FBQTtBQUVMLENBQUMsRUEzS1MsTUFBTSxLQUFOLE1BQU0sUUEyS2YiLCJzb3VyY2VzQ29udGVudCI6WyJuYW1lc3BhY2UgVGV0cmlzIHtcclxuICAgIGltcG9ydCDGkiA9IEZ1ZGdlQ29yZTtcclxuXHJcbiAgICBleHBvcnQgY2xhc3MgRm9ybSBleHRlbmRzIMaSLk5vZGUge1xyXG4gICAgICAgIHB1YmxpYyBzdGF0aWMgc3RhdGljVW5pdDogbnVtYmVyID0gMS4wNTtcclxuICAgICAgICBwdWJsaWMgdW5pdDogbnVtYmVyID0gRm9ybS5zdGF0aWNVbml0O1xyXG5cclxuICAgICAgICBwcml2YXRlIGRpclk6IMaSLlZlY3RvcjMgPSDGki5WZWN0b3IzLlkoLXRoaXMudW5pdCk7XHJcbiAgICAgICAgcHJpdmF0ZSBjb2xvcjogxpIuQ29sb3IgPSDGki5Db2xvci5DU1MoXCJXSElURVwiKTtcclxuICAgICAgICBwcml2YXRlIGNvbnRhaW5lcjogxpIuTm9kZTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3Ioc3RhcnRQb3M6IMaSLlZlY3RvcjMgPSDGki5WZWN0b3IzLlpFUk8oKSkge1xyXG4gICAgICAgICAgICBzdXBlcihcIkZvcm1cIik7XHJcbiAgICAgICAgICAgIHN0YXJ0UG9zLnNjYWxlKHRoaXMudW5pdCk7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkQ29tcG9uZW50KG5ldyDGki5Db21wb25lbnRUcmFuc2Zvcm0oxpIuTWF0cml4NHg0LlRSQU5TTEFUSU9OKHN0YXJ0UG9zKSkpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyDGki5Ob2RlKFwiRm9ybV9Db250YWluZXJcIik7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENvbXBvbmVudChuZXcgxpIuQ29tcG9uZW50VHJhbnNmb3JtKMaSLk1hdHJpeDR4NC5UUkFOU0xBVElPTijGki5WZWN0b3IzLlpFUk8oKSkpKTtcclxuICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLmNvbnRhaW5lcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgc3RhdGljIHJhbmRvbSgpOiBGb3JtIHtcclxuICAgICAgICAgICAgbGV0IHI6IG51bWJlciA9IE1hdGgucmFuZG9tKCk7XHJcbiAgICAgICAgICAgIGxldCBwOiBudW1iZXIgPSAxIC8gNztcclxuICAgICAgICAgICAgbGV0IHJ4OiBudW1iZXIgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMikgLSA2O1xyXG4gICAgICAgICAgICBsZXQgeTogbnVtYmVyID0gMTA7XHJcbiAgICAgICAgICAgIGxldCBmb3JtOiBGb3JtID0gbmV3IEZvcm0obmV3IMaSLlZlY3RvcjMocngsIHksIDApKTtcclxuICAgICAgICAgICAgaWYgKHIgPiBwICogNilcclxuICAgICAgICAgICAgICAgIGZvcm0uY3JlYXRlTE4oKTtcclxuICAgICAgICAgICAgZWxzZSBpZiAociA+IHAgKiA1KVxyXG4gICAgICAgICAgICAgICAgZm9ybS5jcmVhdGVMTCgpO1xyXG4gICAgICAgICAgICBlbHNlIGlmIChyID4gcCAqIDQpXHJcbiAgICAgICAgICAgICAgICBmb3JtLmNyZWF0ZUxSKCk7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHIgPiBwICogMylcclxuICAgICAgICAgICAgICAgIGZvcm0uY3JlYXRlWkwoKTtcclxuICAgICAgICAgICAgZWxzZSBpZiAociA+IHAgKiAyKVxyXG4gICAgICAgICAgICAgICAgZm9ybS5jcmVhdGVaUigpO1xyXG4gICAgICAgICAgICBlbHNlIGlmIChyID4gcCAqIDEpXHJcbiAgICAgICAgICAgICAgICBmb3JtLmNyZWF0ZVNRKCk7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHIgPiBwICogMClcclxuICAgICAgICAgICAgICAgIGZvcm0uY3JlYXRlVFQoKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZvcm07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgc3RhdGljIGZsb29yKGxlbjogbnVtYmVyLCBwb3M6IMaSLlZlY3RvcjMgPSDGki5WZWN0b3IzLlpFUk8oKSk6IEZvcm0ge1xyXG4gICAgICAgICAgICBsZXQgZm9ybTogRm9ybSA9IG5ldyBGb3JtKHBvcyk7XHJcbiAgICAgICAgICAgIGZvcm0uY3JlYXRlTGluZShsZW4sIMaSLlZlY3RvcjMuWkVSTygpKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZvcm07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgc3RhdGljIHdhbGwobGVuOiBudW1iZXIsIHBvczogxpIuVmVjdG9yMyA9IMaSLlZlY3RvcjMuWkVSTygpKTogRm9ybSB7XHJcbiAgICAgICAgICAgIGxldCBmb3JtOiBGb3JtID0gbmV3IEZvcm0ocG9zKTtcclxuICAgICAgICAgICAgd2hpbGUgKGxlbi0tID4gMClcclxuICAgICAgICAgICAgICAgIGZvcm0uY3JlYXRlUXVhZChuZXcgxpIuVmVjdG9yMygwLCBmb3JtLnVuaXQgKiBsZW4gLSBmb3JtLnVuaXQsIDApKTsgMFxyXG4gICAgICAgICAgICByZXR1cm4gZm9ybTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyBnZXQgcG9zaXRpb24oKTogxpIuVmVjdG9yMyB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm10eFdvcmxkLnRyYW5zbGF0aW9uO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIHRyeU1vdmVZKGNvbGxpZGVyczogRm9ybVtdKTogYm9vbGVhbiB7XHJcbiAgICAgICAgICAgIGxldCB0cmFuc2Zvcm06IMaSLkNvbXBvbmVudFRyYW5zZm9ybSA9IHRoaXMuZ2V0Q29tcG9uZW50KMaSLkNvbXBvbmVudFRyYW5zZm9ybSk7XHJcbiAgICAgICAgICAgIGxldCBtYXRyaXg6IMaSLk1hdHJpeDR4NCA9IHRyYW5zZm9ybS5sb2NhbC5jb3B5O1xyXG5cclxuICAgICAgICAgICAgbGV0IG5lZ0RpcjogxpIuVmVjdG9yMyA9IHRoaXMuZGlyWS5jb3B5O1xyXG4gICAgICAgICAgICBuZWdEaXIuc2NhbGUoLTEpO1xyXG4gICAgICAgICAgICBsZXQgbmVnVHJpeDogxpIuTWF0cml4NHg0ID0gdHJhbnNmb3JtLmxvY2FsLmNvcHk7XHJcblxyXG4gICAgICAgICAgICBtYXRyaXgudHJhbnNsYXRlKHRoaXMuZGlyWSk7XHJcbiAgICAgICAgICAgIG5lZ1RyaXgudHJhbnNsYXRlKG5lZ0Rpcik7XHJcblxyXG4gICAgICAgICAgICBsZXQgbmV3VHJhbnNmb3JtOiDGki5Db21wb25lbnRUcmFuc2Zvcm0gPSBuZXcgxpIuQ29tcG9uZW50VHJhbnNmb3JtKG1hdHJpeCk7XHJcbiAgICAgICAgICAgIGxldCBuZWdUcmFuc2Zvcm06IMaSLkNvbXBvbmVudFRyYW5zZm9ybSA9IG5ldyDGki5Db21wb25lbnRUcmFuc2Zvcm0obmVnVHJpeCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNvbXBvbmVudCh0cmFuc2Zvcm0pO1xyXG4gICAgICAgICAgICB0aGlzLmFkZENvbXBvbmVudChuZXdUcmFuc2Zvcm0pO1xyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgY2hpbGQgb2YgdGhpcy5jb250YWluZXIuZ2V0Q2hpbGRyZW4oKSkge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgY29sbGlkZXIgb2YgY29sbGlkZXJzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgb3RoZXIgb2YgY29sbGlkZXIuY29udGFpbmVyLmdldENoaWxkcmVuKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNwOiDGki5WZWN0b3IzID0gY2hpbGQubXR4V29ybGQudHJhbnNsYXRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvcDogxpIuVmVjdG9yMyA9IG90aGVyLm10eFdvcmxkLnRyYW5zbGF0aW9uO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjcC5lcXVhbHMoxpIuVmVjdG9yMy5aRVJPKCkpICYmIGNwLmlzSW5zaWRlU3BoZXJlKG9wLCB0aGlzLnVuaXQgLyAyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVDb21wb25lbnQobmV3VHJhbnNmb3JtKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29tcG9uZW50KG5lZ1RyYW5zZm9ybSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgbW92ZVgoZGlyWDogxpIuVmVjdG9yMyk6IHZvaWQge1xyXG4gICAgICAgICAgICBkaXJYLnNjYWxlKHRoaXMudW5pdCk7XHJcbiAgICAgICAgICAgIGxldCB0cmFuc2Zvcm06IMaSLkNvbXBvbmVudFRyYW5zZm9ybSA9IHRoaXMuZ2V0Q29tcG9uZW50KMaSLkNvbXBvbmVudFRyYW5zZm9ybSk7XHJcbiAgICAgICAgICAgIGxldCBtYXRyaXg6IMaSLk1hdHJpeDR4NCA9IHRyYW5zZm9ybS5sb2NhbC5jb3B5O1xyXG4gICAgICAgICAgICBtYXRyaXgudHJhbnNsYXRlKGRpclgpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNvbXBvbmVudCh0cmFuc2Zvcm0pO1xyXG4gICAgICAgICAgICB0aGlzLmFkZENvbXBvbmVudChuZXcgxpIuQ29tcG9uZW50VHJhbnNmb3JtKG1hdHJpeCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIHJvdGF0ZVooZGlyOiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICAgICAgbGV0IHRyYW5zZm9ybTogxpIuQ29tcG9uZW50VHJhbnNmb3JtID0gdGhpcy5jb250YWluZXIuZ2V0Q29tcG9uZW50KMaSLkNvbXBvbmVudFRyYW5zZm9ybSk7XHJcbiAgICAgICAgICAgIGxldCBtYXRyaXg6IMaSLk1hdHJpeDR4NCA9IHRyYW5zZm9ybS5sb2NhbC5jb3B5O1xyXG4gICAgICAgICAgICBtYXRyaXgucm90YXRlWihkaXIgKiA5MCk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNvbXBvbmVudCh0cmFuc2Zvcm0pO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDb21wb25lbnQobmV3IMaSLkNvbXBvbmVudFRyYW5zZm9ybShtYXRyaXgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByaXZhdGUgY3JlYXRlTGluZShsZW46IG51bWJlciwgcG9zOiDGki5WZWN0b3IzID0gxpIuVmVjdG9yMy5aRVJPKCkpOiB2b2lkIHtcclxuICAgICAgICAgICAgd2hpbGUgKGxlbi0tID4gMClcclxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUXVhZChuZXcgxpIuVmVjdG9yMyh0aGlzLnVuaXQgKiBsZW4gLSB0aGlzLnVuaXQgKyBwb3MueCwgMCArIHBvcy55LCAwICsgcG9zLnopKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByaXZhdGUgY3JlYXRlTE4oKTogdm9pZCB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSDGki5Db2xvci5DU1MoXCJDWUFOXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoNCwgxpIuVmVjdG9yMy5aRVJPKCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBjcmVhdGVMTCgpOiB2b2lkIHtcclxuICAgICAgICAgICAgdGhpcy5jb2xvciA9IMaSLkNvbG9yLkNTUyhcIk1BR0VOVEFcIik7XHJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgzKTtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVRdWFkKG5ldyDGki5WZWN0b3IzKC10aGlzLnVuaXQsIHRoaXMudW5pdCwgMCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBjcmVhdGVMUigpOiB2b2lkIHtcclxuICAgICAgICAgICAgdGhpcy5jb2xvciA9IMaSLkNvbG9yLkNTUyhcIllFTExPV1wiKTtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKDMpO1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVF1YWQobmV3IMaSLlZlY3RvcjModGhpcy51bml0LCB0aGlzLnVuaXQsIDApKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByaXZhdGUgY3JlYXRlWkwoKTogdm9pZCB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSDGki5Db2xvci5DU1MoXCJSRURcIik7XHJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlTGluZSgyLCBuZXcgxpIuVmVjdG9yMyh0aGlzLnVuaXQsIDAsIDApKTtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKDIsIG5ldyDGki5WZWN0b3IzKDAsIDAgKyB0aGlzLnVuaXQsIDApKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByaXZhdGUgY3JlYXRlWlIoKTogdm9pZCB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSDGki5Db2xvci5DU1MoXCJHUkVFTlwiKTtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKDIpO1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoMiwgbmV3IMaSLlZlY3RvcjModGhpcy51bml0LCAwICsgdGhpcy51bml0LCAwKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIGNyZWF0ZVNRKCk6IHZvaWQge1xyXG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gxpIuQ29sb3IuQ1NTKFwiQkxVRVwiKTtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKDIpO1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoMiwgbmV3IMaSLlZlY3RvcjMoMCwgdGhpcy51bml0LCAwKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIGNyZWF0ZVRUKCk6IHZvaWQge1xyXG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gxpIuQ29sb3IuQ1NTKFwiT1JBTkdFXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoMyk7XHJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlUXVhZChuZXcgxpIuVmVjdG9yMygwLCAwICsgdGhpcy51bml0LCAwKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIGNyZWF0ZVF1YWQocG9zOiDGki5WZWN0b3IzKTogdm9pZCB7XHJcbiAgICAgICAgICAgIGxldCBtZXNoOiDGki5NZXNoUXVhZCA9IG5ldyDGki5NZXNoUXVhZCgpO1xyXG4gICAgICAgICAgICBsZXQgbWF0ZXJpYWw6IMaSLk1hdGVyaWFsID0gbmV3IMaSLk1hdGVyaWFsKFwiU29saWRcIiArIHRoaXMuY29sb3IuZ2V0Q1NTKCksIMaSLlNoYWRlclVuaUNvbG9yLCBuZXcgxpIuQ29hdENvbG9yZWQodGhpcy5jb2xvcikpO1xyXG4gICAgICAgICAgICBsZXQgc2VnbWVudDogxpIuTm9kZSA9IG5ldyDGki5Ob2RlKFwiU2VnbWVudFwiKTtcclxuICAgICAgICAgICAgbGV0IGNtcE1lc2g6IMaSLkNvbXBvbmVudE1lc2ggPSBuZXcgxpIuQ29tcG9uZW50TWVzaChtZXNoKTtcclxuICAgICAgICAgICAgc2VnbWVudC5hZGRDb21wb25lbnQoY21wTWVzaCk7XHJcbiAgICAgICAgICAgIGxldCBjbXBNYXRlcmlhbDogxpIuQ29tcG9uZW50TWF0ZXJpYWwgPSBuZXcgxpIuQ29tcG9uZW50TWF0ZXJpYWwobWF0ZXJpYWwpO1xyXG4gICAgICAgICAgICBzZWdtZW50LmFkZENvbXBvbmVudChjbXBNYXRlcmlhbCk7XHJcbiAgICAgICAgICAgIHNlZ21lbnQuYWRkQ29tcG9uZW50KG5ldyDGki5Db21wb25lbnRUcmFuc2Zvcm0oxpIuTWF0cml4NHg0LlRSQU5TTEFUSU9OKHBvcykpKTtcclxuICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQoc2VnbWVudCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbn0iXX0=